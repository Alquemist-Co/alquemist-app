# ALQUEMIST

## Modelo de Datos Definitivo

*Sistema de Gesti√≥n para Cultivos de Cualquier Tipo*

46 tablas ¬∑ 9 dominios + nexo ¬∑ 9 tablas CORE

Febrero 2026 ¬∑ v2.0

---

## Tabla de Contenidos

1. Visi√≥n General de la Arquitectura
2. Principios de Dise√±o
3. Flujo de Datos General
4. Diccionario de Tablas
   - Dominio: Sistema
   - Dominio: Producci√≥n
   - Dominio: √Åreas
   - Dominio: Inventario
   - Dominio: Actividades
   - Dominio: Nexo (Batches)
   - Dominio: √ìrdenes
   - Dominio: Calidad
   - Dominio: Regulatorio
   - Dominio: Operaciones
5. Relaciones Cross-Domain
6. Flujos Operativos Detallados
7. √çndices Recomendados y Queries Habilitadas

---

## Visi√≥n General de la Arquitectura

Alquemist es un modelo de datos dise√±ado para gestionar el ciclo completo de producci√≥n agr√≠cola, desde la semilla hasta el producto final empacado. Su arquitectura se organiza en **9 dominios independientes** conectados por un nexo central (**batches**), lo que permite que cada dominio evolucione sin romper los dem√°s.

El modelo soporta cualquier tipo de cultivo (cannabis, ar√°ndanos, fresas, hortalizas) mediante fases de producci√≥n configurables por tipo de cultivo. Las √≥rdenes de producci√≥n permiten seleccionar subconjuntos de fases, habilitando que viveros, procesadores y cultivadores full-cycle operen sobre el mismo sistema.

| Dominio | Tablas | Prop√≥sito |
|---|---|---|
| **Sistema** ‚öôÔ∏è | companies, users | Multi-tenancy, roles y permisos |
| **Producci√≥n** üß¨ | crop_types, cultivars, production_phases, phase_product_flows, phytosanitary_agents | QU√â se produce ‚Äî fases configurables, transformaciones por cultivar, cat√°logo fitosanitario |
| **√Åreas** üè≠ | facilities, zones, zone_structures, plant_positions | D√ìNDE ‚Äî jerarqu√≠a espacial flexible |
| **Inventario** üì¶ | resource_categories, products, units_of_measure, suppliers, inventory_items, inventory_transactions, recipes, recipe_executions | CON QU√â ‚Äî recursos con transacciones inmutables |
| **Actividades** üìã | activity_types, activity_templates, activity_template_phases, activity_template_resources, activity_template_checklist, cultivation_schedules, scheduled_activities, activities, activity_resources, activity_observations | QU√â se hace ‚Äî template ‚Üí scheduled ‚Üí activity |
| **Nexo** üå± | batches, batch_lineage | Conecta todo ‚Äî lote de producci√≥n central |
| **√ìrdenes** üìã | production_orders, production_order_phases | QU√â fases ejecutar ‚Äî con entry/exit point |
| **Calidad** üî¨ | quality_tests, quality_test_results | CUMPLE est√°ndar ‚Äî laboratorio flexible |
| **Regulatorio** üìú | regulatory_doc_types, product_regulatory_requirements, regulatory_documents, shipment_doc_requirements, shipments, shipment_items | CUMPLE normativa ‚Äî documentaci√≥n y trazabilidad de transporte |
| **Operaciones** üì° | overhead_costs, sensors, environmental_readings, alerts, attachments | Soporte transversal ‚Äî IoT, costos, alertas |

---

## Principios de Dise√±o

**Dominios independientes:** Cada dominio puede evolucionar sin afectar a los dem√°s. Las dependencias cross-domain se limitan a FKs bien definidas.

**Batch como nexo:** El lote de producci√≥n conecta los 9 dominios: sabe su cultivar, zona, producto actual, schedule, orden, fase actual, y puede tener tests de calidad, lecturas ambientales, documentos regulatorios y env√≠os.

**Transacciones inmutables:** inventory_transactions es append-only: nunca se edita ni borra. Todo el estado del inventario se reconstruye desde el log. Cada transacci√≥n registra contexto completo (zona + batch + fase + actividad + usuario).

**Fases configurables:** Cada tipo de cultivo define sus propias fases. El status del batch se deriva de current_phase_id, no de valores hardcoded. Cannabis puede tener 8 fases (incluyendo madre), ar√°ndanos 4, y fresas 5 sin cambiar c√≥digo. Las fases soportan bifurcaciones via depends_on_phase_id: la fase 'madre' bifurca desde 'vegetativo' en paralelo a 'floraci√≥n', permitiendo ciclos de producci√≥n de clones indefinidos.

**Transformaci√≥n por cultivar:** phase_product_flows es la √öNICA fuente de verdad para qu√© entra y sale de cada fase, definida a nivel de cultivar. Cada variedad tiene sus propios productos, yields y cadena de transformaci√≥n. Las fases (estructura del ciclo) son del crop_type; los flows (qu√© se transforma y con qu√© rendimiento) son del cultivar.

**√ìrdenes flexibles:** entry_phase_id y exit_phase_id permiten que una orden cubra un subconjunto de fases. Vivero: fases 1-2. Procesador: fases 5-7. Full-cycle: fases 1-7. Madre: fases 1-3 + madre (bifurcaci√≥n). La generaci√≥n de order_phases sigue la cadena depends_on desde entry hasta exit, soportando tanto el flujo lineal como las bifurcaciones.

**Producto como fuente de verdad de unidades:** Cada producto define su default_unit_id. Conversiones misma dimensi√≥n via units_of_measure. Conversiones cross-dimensi√≥n via products.density_g_per_ml.

**Template ‚Üí Instancia:** Los patrones de configuraci√≥n se definen como templates reutilizables (activity_templates, regulatory_doc_types) y las ejecuciones reales son instancias concretas (activities, regulatory_documents). Esto aplica consistentemente en actividades, calidad y documentaci√≥n regulatoria.

**Campos din√°micos via JSONB:** Los tipos de documento regulatorio definen campos requeridos en un JSON schema (required_fields); las instancias guardan valores en field_data. Esto evita crear N columnas por tipo y permite configuraci√≥n por empresa sin migraciones.

**Auditor√≠a universal:** Todas las tablas incluyen created_at, updated_at, created_by, updated_by. Cat√°logos usan is_active como soft-delete. Tablas transaccionales son append-only.

---

## Flujo de Datos General

El modelo opera en dos cadenas principales que convergen en el batch:

**Cadena de Configuraci√≥n y Planificaci√≥n**

cultivar ‚Üí production_phases ‚Üí production_order ‚Üí batch

Se selecciona un cultivar, el sistema carga sus fases, se crea una orden con entry/exit point, y al aprobar se genera el batch con toda su configuraci√≥n.

**Tres Rutas de Ingreso de Material Vegetal**

El material vegetal entra al sistema por tres rutas, cada una con diferente entry_phase y trazabilidad:

semilla externa ‚Üí shipment ‚Üí inventory_item ‚Üí orden (entry=germinaci√≥n) ‚Üí batch
esqueje externo ‚Üí shipment ‚Üí inventory_item ‚Üí orden (entry=propagaci√≥n) ‚Üí batch
esqueje interno ‚Üí planta madre (batch activo en fase madre) ‚Üí CLONE-CUT ‚Üí inventory_item ‚Üí orden (entry=propagaci√≥n) ‚Üí batch

Las tres rutas convergen en la misma cadena de ejecuci√≥n operativa una vez creado el batch. La trazabilidad hacia atr√°s var√≠a: material externo llega hasta shipment ‚Üí supplier ‚Üí docs regulatorios; material interno llega hasta el batch madre ‚Üí su propio origen.

**Cadena de Ejecuci√≥n Operativa**

activity_template ‚Üí scheduled_activity ‚Üí activity ‚Üí inventory_transaction ‚Üí inventory_item

Los templates definen la receta de actividad. Al programar se toma un snapshot. Al ejecutar, el operario registra recursos reales que generan transacciones inmutables de inventario.

**Cadenas de Soporte**

sensor ‚Üí environmental_reading ¬∑ quality_test ‚Üí quality_test_results ¬∑ overhead_costs ‚Üí allocation a batches

**Cadena Regulatoria**

regulatory_doc_types ‚Üí product_regulatory_requirements ‚Üí regulatory_documents ¬∑ shipments ‚Üí shipment_items ‚Üí inventory_items

Los tipos de documento definen qu√© se necesita. Los requerimientos vinculan tipos con productos/categor√≠as. Los documentos capturados satisfacen esos requerimientos. Los shipments registran el viaje completo del material y al confirmar recepci√≥n crean inventory_items.

**V√≠nculo central:** Todo se vincula a **batch** + **zone** + **phase**. Esta tripleta permite cualquier consulta anal√≠tica.

---

## Diccionario de Tablas

Definici√≥n completa de las 46 tablas organizadas por dominio. Los campos marcados como 'cross-domain' son FKs que conectan dominios entre s√≠. Todas las tablas incluyen campos de auditor√≠a est√°ndar (created_at, updated_at, created_by, updated_by) que no se listan expl√≠citamente.

---

### Dominio: Sistema

#### companies

Empresa / tenant ‚Äî ra√≠z del multi-tenancy. Cada empresa opera de forma aislada con su propia configuraci√≥n de moneda, zona horaria y features habilitados.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **name** | VARCHAR | *'AgroTech Colombia SAS'* |
| **legal_id** | VARCHAR opt | *NIT, RFC, EIN* |
| **country** | CHAR(2) | *'CO', 'US', 'MX'* |
| **timezone** | VARCHAR | *'America/Bogota'* |
| **currency** | CHAR(3) | *'COP', 'USD'* |
| **settings** | JSONB opt | *{logo_url, regulatory_mode, features_enabled, regulatory_blocking_enabled}* |
| **is_active** | BOOLEAN | *default true ‚Äî soft delete* |

#### users

Usuarios del sistema con rol y permisos granulares. Cada usuario pertenece a una empresa y opcionalmente a una instalaci√≥n.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **company_id** | FK ‚Üí companies | |
| **email** | VARCHAR UNIQUE | |
| **full_name** | VARCHAR | |
| **role** | ENUM | *admin \| manager \| supervisor \| operator \| viewer* |
| **phone** | VARCHAR opt | |
| **assigned_facility_id** | FK ‚Üí facilities opt | *facility principal del usuario* |
| **permissions** | JSONB opt | *{can_approve_orders, can_adjust_inventory, can_delete}* |
| **is_active** | BOOLEAN | *default true* |
| **last_login_at** | TIMESTAMPTZ opt | |

---

### Dominio: Producci√≥n

#### crop_types

Tipo de cultivo que define el universo de fases y productos. Cada crop_type tiene sus propias production_phases configurables, lo que permite que cannabis tenga 8 fases (incluyendo madre para clonaci√≥n), ar√°ndanos 4, y fresas 5 sin cambiar c√≥digo.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **code** | VARCHAR UNIQUE | *'cannabis', 'blueberry', 'strawberry'* |
| **name** | VARCHAR | *'Cannabis Medicinal'* |
| **scientific_name** | VARCHAR opt | *'Cannabis sativa L.'* |
| **category** | ENUM | *annual \| perennial \| biennial* |
| **regulatory_framework** | VARCHAR opt | *'Resoluci√≥n 227/2022'* |
| **icon** | VARCHAR opt | |
| **is_active** | BOOLEAN | *default true* |

#### cultivars [CORE]

Variedad espec√≠fica dentro de un tipo de cultivo. Define caracter√≠sticas de rendimiento, ciclo, perfil objetivo y condiciones √≥ptimas de cultivo. Es el punto de partida para cualquier orden de producci√≥n.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **crop_type_id** | FK ‚Üí crop_types | |
| **code** | VARCHAR UNIQUE | *'GELATO-41', 'DUKE-BB'* |
| **name** | VARCHAR | *'Gelato #41'* |
| **breeder** | VARCHAR opt | *'Seed Junky Genetics'* |
| **genetics** | VARCHAR opt | *'Sunset Sherbet √ó Thin Mint GSC'* |
| **default_cycle_days** | INT opt | *127 ‚Äî duraci√≥n total del ciclo* |
| **phase_durations** | JSONB opt | *{germination:7, vegetative:28, flowering:63}* |
| **expected_yield_per_plant_g** | DECIMAL opt | *500* |
| **expected_dry_ratio** | DECIMAL opt | *0.25 (25% peso h√∫medo ‚Üí seco)* |
| **target_profile** | JSONB opt | *{THC:'20-25%', terpenes:['limonene']}* |
| **quality_grade** | VARCHAR opt | *'Premium Indoor'* |
| **optimal_conditions** | JSONB opt | *{temp:'20-26¬∞C', RH:'40-60%', EC:'1.2-2.4'}* |
| **density_plants_per_m2** | DECIMAL opt | *9* |
| **notes** | TEXT opt | |
| **is_active** | BOOLEAN | *default true* |

#### production_phases [CORE]

Fases de producci√≥n CONFIGURABLES por tipo de cultivo. Definen la secuencia del ciclo productivo. El status del batch se deriva directamente de la fase actual. Cada fase indica si transforma producto, si destruye el input, y si puede ser entry o exit point para √≥rdenes parciales. La combinaci√≥n is_transformation + is_destructive define el comportamiento: is_destructive=true destruye el input (cosecha), is_destructive=false lo preserva (clonaci√≥n desde planta madre). Las fases soportan bifurcaciones via depends_on_phase_id: la fase 'madre' depende de 'vegetativo' y existe en paralelo a 'floraci√≥n', permitiendo que una orden derive hacia mantenimiento de madre en vez de continuar el ciclo productivo.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **crop_type_id** | FK ‚Üí crop_types | |
| **code** | VARCHAR | *'germination', 'flowering', 'drying', 'madre'* |
| **name** | VARCHAR | *'Floraci√≥n', 'Planta Madre'* |
| **sort_order** | INT | *secuencia: 1, 2, 3... (madre=8, fuera del flujo lineal)* |
| **is_transformation** | BOOLEAN | *true = producto cambia de estado* |
| **is_destructive** | BOOLEAN | *true = input se destruye (cosecha). false = input se preserva (madre produce clones sin destruirse)* |
| **default_duration_days** | INT opt | *63 floraci√≥n, 14 secado, null para madre (indefinida)* |
| **requires_zone_change** | BOOLEAN | *true si debe cambiar de sala* |
| **can_skip** | BOOLEAN | *default false ‚Äî fase opcional en √≥rdenes* |
| **can_be_entry_point** | BOOLEAN | *default false ‚Äî comprar clones = empezar en propagaci√≥n* |
| **can_be_exit_point** | BOOLEAN | *default false ‚Äî vender sin empacar = terminar en secado* |
| **depends_on_phase_id** | FK ‚Üí self opt | *secado depende de cosecha, madre depende de vegetativo* |
| **icon, color** | VARCHAR opt | |

Ejemplo de fases para cannabis medicinal:

| sort_order | code | is_transformation | is_destructive | depends_on | Notas |
|---|---|---|---|---|---|
| 1 | germination | true | true | ‚Äî | semillas ‚Üí pl√°ntulas |
| 2 | propagation | true | false | germination | enraizamiento de pl√°ntulas/esquejes |
| 3 | vegetative | true | false | propagation | crecimiento vegetativo |
| 4 | flowering | true | false | vegetative | floraci√≥n (fotoperiodo 12/12) |
| 5 | harvest | true | true | flowering | cosecha: destruye plantas, genera flor h√∫meda |
| 6 | drying | true | true | harvest | secado: h√∫meda ‚Üí seca |
| 7 | packaging | true | true | drying | empaque: granel ‚Üí unidades |
| 8 | madre | true | false | vegetative | **bifurcaci√≥n**: produce clones sin destruirse |

La fase madre bifurca desde vegetativo en paralelo a floraci√≥n. Una orden de producci√≥n de tipo "madre" usa entry_phase=germinaci√≥n, exit_phase=madre, y solo incluye las fases germinaci√≥n ‚Üí propagaci√≥n ‚Üí vegetativo ‚Üí madre. El batch permanece en fase madre indefinidamente, recibiendo actividades peri√≥dicas de clonaci√≥n.

#### phase_product_flows [CORE]

FUENTE DE VERDAD de transformaci√≥n ‚Äî define QU√â ENTRA y QU√â SALE de cada fase **para cada cultivar**. Cada variedad tiene sus propios productos y rendimientos de transformaci√≥n. Cuando un batch avanza de fase, esta tabla determina qu√© inventory_items se crean y destruyen. La cadena vegetal se deriva de flows consecutivos: el output de la fase N es el input de la fase N+1. Las fases (estructura del ciclo) pertenecen al crop_type; los flows (qu√© se transforma y con qu√© rendimiento) pertenecen al cultivar.

Al crear un cultivar nuevo, la UI ofrece "Copiar flows de un cultivar existente" del mismo crop_type como punto de partida.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **cultivar_id** | FK ‚Üí cultivars | *cada cultivar define sus propios flows ‚Äî no hay herencia de crop_type* |
| **phase_id** | FK ‚Üí production_phases | *el par (cultivar_id, phase_id) es el contexto completo* |
| **direction** | ENUM | *'input' \| 'output'* |
| **product_role** | ENUM | *'primary' \| 'secondary' \| 'byproduct' \| 'waste'* |
| **product_id** | FK ‚Üí products opt | *producto espec√≠fico (cultivar-specific): WET-GELATO, DRY-BLUEDREAM* |
| **product_category_id** | FK ‚Üí resource_categories opt | *O categor√≠a gen√©rica para insumos no cultivar-specific* |
| **expected_yield_pct** | DECIMAL opt | *90% germinaci√≥n, 25% seco/h√∫medo ‚Äî var√≠a por cultivar* |
| **expected_quantity_per_input** | DECIMAL opt | *500g flor h√∫meda por planta (Gelato), 350g (Blue Dream)* |
| **unit_id** | FK ‚Üí units_of_measure opt | |
| **is_required** | BOOLEAN | *default true ‚Äî false = output opcional (trim)* |
| **sort_order** | INT | |
| **notes** | TEXT opt | |

Los productos de un cultivar se derivan de esta tabla: `SELECT DISTINCT product_id FROM phase_product_flows WHERE cultivar_id = X AND product_id IS NOT NULL`. No se necesita una tabla separada de cat√°logo de SKUs por cultivar.

#### phytosanitary_agents

Cat√°logo de plagas, enfermedades y otros agentes fitosanitarios configurables por empresa. Permite selecci√≥n estandarizada durante monitoreos MIPE, analytics limpios (GROUP BY agent_id) y gu√≠as visuales para los operarios. Opcionalmente filtrable por tipo de cultivo.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **company_id** | FK ‚Üí companies | *cada empresa configura su cat√°logo* |
| **type** | ENUM | *'pest' \| 'disease' \| 'deficiency' \| 'abiotic'* |
| **category** | ENUM | *'insect' \| 'mite' \| 'fungus' \| 'bacteria' \| 'virus' \| 'nematode' \| 'mollusk' \| 'nutrient' \| 'environmental' \| 'other'* |
| **code** | VARCHAR UNIQUE per company | *'ACARO_BLANCO', 'BOTRYTIS_SP', 'DEF_CA'* |
| **common_name** | VARCHAR | *'√Åcaro blanco', 'Moho gris', 'Deficiencia de Calcio'* |
| **scientific_name** | VARCHAR opt | *'Polyphagotarsonemus latus', 'Botrytis cinerea'* |
| **default_plant_parts** | JSONB opt | *['leaf', 'flower'] ‚Äî partes que t√≠picamente afecta, preselecci√≥n en UI* |
| **visual_symptoms** | TEXT opt | *'Hojas enrolladas hacia abajo, bordes clor√≥ticos, aspecto aceitoso en env√©s'* |
| **recommended_actions** | TEXT opt | *'Aplicar acaricida de contacto, aumentar ventilaci√≥n, reducir densidad'* |
| **severity_scale** | JSONB opt | *{low:'<10% √°rea', medium:'10-30%', high:'30-60%', critical:'>60%'}* |
| **crop_type_id** | FK ‚Üí crop_types opt | *null = aplica a cualquier cultivo, o filtrar por tipo espec√≠fico* |
| **sort_order** | INT | |
| **is_active** | BOOLEAN | *default true* |

La UI filtra agentes por crop_type del batch activo: primero los espec√≠ficos del crop_type, luego los gen√©ricos (crop_type_id IS NULL), y siempre ofrece opci√≥n "Otro" que permite registrar texto libre en activity_observations.description.

---

### Dominio: √Åreas

#### facilities

Instalaci√≥n f√≠sica ‚Äî ra√≠z de la jerarqu√≠a espacial. Cada facility pertenece a una empresa y contiene N zonas. Los campos calculados se derivan de las zonas hijas.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **company_id** | FK ‚Üí companies | |
| **name** | VARCHAR | *'Invernadero Principal'* |
| **type** | ENUM | *indoor_warehouse \| greenhouse \| tunnel \| open_field \| vertical_farm* |
| **total_footprint_m2** | DECIMAL | *500.00* |
| **total_growing_area_m2** | DECIMAL calc | *Œ£(zones.effective_growing_area_m2)* |
| **total_plant_capacity** | INT calc | *Œ£(zones.plant_capacity)* |
| **address** | TEXT | |
| **latitude, longitude** | DECIMAL opt | |
| **is_active** | BOOLEAN | *default true* |

#### zones [CORE]

Espacio f√≠sico real (sala, nave, lote) ‚Äî UNIDAD OPERATIVA PRINCIPAL. Las zonas son donde ocurren las actividades y donde viven los batches. La capacidad se calcula desde zone_structures si existen, o se establece directamente para zonas simples (campo abierto, t√∫neles sin estructuras internas).

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **facility_id** | FK ‚Üí facilities | |
| **name** | VARCHAR | *'Sala Vegetativo A', 'Lote Norte'* |
| **purpose** | ENUM | *propagation \| vegetation \| flowering \| drying \| processing \| storage \| multipurpose* |
| **environment** | ENUM | *indoor_controlled \| greenhouse \| tunnel \| open_field* |
| **area_m2** | DECIMAL | *√°rea de piso* |
| **height_m** | DECIMAL opt | |
| **effective_growing_area_m2** | DECIMAL calc | *con structures: Œ£(area√ólevels), sin: area_m2* |
| **plant_capacity** | INT calc | *con structures: Œ£(max_positions), sin: area_m2 √ó density* |
| **climate_config** | JSONB opt | *{temp, HR, CO‚ÇÇ, fotoperiodo}* |
| **status** | ENUM | *active \| maintenance \| inactive* |

#### zone_structures

OPCIONAL ‚Äî Configuraci√≥n f√≠sica dentro de una zona para calcular capacidad. Solo necesaria para zonas con racks verticales, mesas rolling, hileras, o cualquier estructura que multiplique el √°rea efectiva. Zonas simples (campo abierto) no requieren esta tabla.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **zone_id** | FK ‚Üí zones | |
| **name** | VARCHAR | *'Rack A1', 'Hilera 3', 'Mesa Rolling B'* |
| **type** | ENUM | *mobile_rack \| fixed_rack \| rolling_bench \| row \| bed \| trellis_row \| nft_channel* |
| **length_m** | DECIMAL | |
| **width_m** | DECIMAL | |
| **is_mobile** | BOOLEAN | *default false* |
| **num_levels** | INT | *default 1 ‚Äî suelo/hilera=1, racks=2-8* |
| **positions_per_level** | INT opt | *posiciones de planta por nivel* |
| **max_positions** | INT calc | *num_levels √ó positions_per_level* |
| **level_config** | JSONB opt | *[{level:1, height_m, lighting, irrigation, substrate}]* |
| **spacing_cm** | DECIMAL opt | *entre plantas* |
| **pot_size_L** | DECIMAL opt | |

#### plant_positions

OPCIONAL ‚Äî Spot individual de planta. Solo se usa cuando se requiere trazabilidad por planta individual (regulaci√≥n cannabis medicinal, investigaci√≥n). Para cultivos extensivos NO se crean posiciones: el batch opera a nivel de zona.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **zone_id** | FK ‚Üí zones | |
| **structure_id** | FK ‚Üí zone_structures opt | *si la zona tiene estructuras* |
| **level_number** | INT opt | *nivel dentro de la estructura* |
| **position_index** | INT | |
| **label** | VARCHAR opt | *'A1-L2-P05' para trazabilidad* |
| **status** | ENUM | *empty \| planted \| harvested \| maintenance* |
| **current_batch_id** | FK ‚Üí batches opt | *cross-domain* |

---

### Dominio: Inventario

#### resource_categories

Categor√≠as jer√°rquicas de recursos con 11 tipos base configurables y herencia padre-hijo. Determinan el comportamiento: si es consumible, depreciable o transformable.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **parent_id** | FK ‚Üí self opt | *nutrient ‚Üí nutrient.salt ‚Üí nutrient.salt.calcium* |
| **name, code** | VARCHAR | |
| **icon, color** | VARCHAR opt | |
| **is_consumable** | BOOLEAN | *true = se agota (insumos, EPP)* |
| **is_depreciable** | BOOLEAN | *true = equipos con vida √∫til* |
| **is_transformable** | BOOLEAN | *true = material vegetal* |
| **default_lot_tracking** | ENUM | *required \| optional \| none* |
| **is_active** | BOOLEAN | *default true* |

#### products [CORE]

Cat√°logo maestro ‚Äî TODO lo que existe como recurso o producto. FUENTE DE VERDAD para unidades de medida. Incluye propiedades de conversi√≥n producto-espec√≠ficas para transformaciones cross-dimensi√≥n (densidad para volumen‚Üîmasa). La cadena de transformaci√≥n se deriva de phase_product_flows a nivel de cultivar.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **sku** | VARCHAR UNIQUE | *SEM-GELATO-FEM, CANO3-25KG* |
| **name** | VARCHAR | |
| **category_id** | FK ‚Üí resource_categories | |
| **default_unit_id** | FK ‚Üí units_of_measure | *FUENTE DE VERDAD de unidad* |
| **cultivar_id** | FK ‚Üí cultivars opt | *vincula producto vegetal con variedad (cross-domain)* |
| **procurement_type** | ENUM | *purchased \| produced \| both* |
| **lot_tracking** | ENUM | *required \| optional \| none* |
| **shelf_life_days** | INT opt | *auto-calcula vencimiento* |
| **phi_days** | INT opt | *Pre-Harvest Interval* |
| **rei_hours** | INT opt | *Re-Entry Interval* |
| **default_yield_pct** | DECIMAL opt | *90% germinaci√≥n, 25% seco/h√∫medo* |
| **density_g_per_ml** | DECIMAL opt | *para convertir volumen‚Üîmasa en este producto* |
| **conversion_properties** | JSONB opt | *{ppm_factor, dilution_ratio}* |
| **default_price** | DECIMAL opt | |
| **price_currency** | CHAR(3) opt | *COP, USD* |
| **preferred_supplier_id** | FK ‚Üí suppliers opt | |
| **requires_regulatory_docs** | BOOLEAN | *default false ‚Äî true si tiene entries en product_regulatory_requirements* |
| **is_active** | BOOLEAN | *default true* |

#### units_of_measure

Unidades con conversiones dentro de la misma dimensi√≥n (kg‚Üíg, L‚ÜímL). Las conversiones cross-dimensi√≥n (volumen‚Üîmasa) viven en products.density_g_per_ml.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **code, name** | VARCHAR | *kg / Kilogramo, mL / Mililitro* |
| **dimension** | ENUM | *mass \| volume \| count \| area \| energy \| time \| concentration* |
| **base_unit_id** | FK ‚Üí self opt | *g para mass, mL para volume* |
| **to_base_factor** | DECIMAL | *√ó1000 para kg‚Üíg* |

#### suppliers

Proveedores de insumos y servicios.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **company_id** | FK ‚Üí companies | |
| **name** | VARCHAR | |
| **contact_info** | JSONB | |
| **payment_terms** | VARCHAR opt | |
| **is_active** | BOOLEAN | *default true* |

#### inventory_items

Instancias de stock ‚Äî CU√ÅNTO hay, D√ìNDE, de QU√â lote. Cada registro representa un lote espec√≠fico de un producto en una ubicaci√≥n. Los campos quantity_reserved y quantity_committed permiten control de disponibilidad en tiempo real.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **product_id** | FK ‚Üí products | |
| **zone_id** | FK ‚Üí zones opt | *d√≥nde est√° almacenado (cross-domain)* |
| **quantity_available** | DECIMAL | |
| **quantity_reserved** | DECIMAL | *reservado para actividades programadas* |
| **quantity_committed** | DECIMAL | *comprometido en ejecuci√≥n* |
| **unit_id** | FK ‚Üí units_of_measure | |
| **batch_number** | VARCHAR opt | *lote interno* |
| **supplier_lot_number** | VARCHAR opt | |
| **cost_per_unit** | DECIMAL opt | |
| **expiration_date** | DATE opt | |
| **source_type** | ENUM | *purchase \| production \| transfer \| transformation* |
| **lot_status** | ENUM | *available \| quarantine \| expired \| depleted* |
| **shipment_item_id** | FK ‚Üí shipment_items opt | *link al item del env√≠o que origin√≥ este lote (cross-domain REG)* |

#### inventory_transactions [CORE]

Log INMUTABLE (append-only) de cada movimiento de recurso. NUNCA se edita ni borra. Cada transacci√≥n registra contexto completo: zona, batch, fase, actividad y usuario, lo que permite reconstruir el estado del inventario en cualquier momento y calcular costos por cualquier dimensi√≥n.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **type** | ENUM | *receipt \| consumption \| application \| transfer_out \| transfer_in \| transformation_out \| transformation_in \| adjustment \| waste \| return \| reservation \| release* |
| **inventory_item_id** | FK ‚Üí inventory_items | |
| **quantity** | DECIMAL | *siempre POSITIVO, type determina +/-* |
| **unit_id** | FK ‚Üí units_of_measure | |
| **timestamp** | TIMESTAMPTZ | *momento exacto ‚Äî inmutable* |
| **zone_id** | FK ‚Üí zones opt | *cross-domain* |
| **batch_id** | FK ‚Üí batches opt | *cross-domain* |
| **phase_id** | FK ‚Üí production_phases opt | *cross-domain* |
| **activity_id** | FK ‚Üí activities opt | *cross-domain* |
| **recipe_execution_id** | FK ‚Üí recipe_executions opt | |
| **related_transaction_id** | FK ‚Üí self opt | *vincula out‚Üîin de transformaci√≥n* |
| **target_item_id** | FK ‚Üí inventory_items opt | *item destino creado* |
| **cost_per_unit** | DECIMAL opt | |
| **cost_total** | DECIMAL opt | |
| **user_id** | FK ‚Üí users | |
| **reason** | TEXT opt | *obligatorio para waste y adjustment* |

#### recipes

F√≥rmulas / BOM (soluci√≥n nutritiva, mezcla sustrato, etc.).

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **name, code** | VARCHAR | |
| **output_product_id** | FK ‚Üí products | |
| **base_quantity** | DECIMAL | *1000L base* |
| **base_unit_id** | FK ‚Üí units_of_measure | |
| **items** | JSONB | *[{product_id, quantity, unit_id}]* |
| **is_active** | BOOLEAN | *default true* |

#### recipe_executions

Cada ejecuci√≥n de una receta ‚Äî agrupa N transacciones de inventario.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **recipe_id** | FK ‚Üí recipes | |
| **executed_by** | FK ‚Üí users | |
| **scale_factor** | DECIMAL | *base 1000L, hice 500L ‚Üí 0.5* |
| **output_quantity_expected** | DECIMAL | |
| **output_quantity_actual** | DECIMAL | |
| **yield_pct** | DECIMAL calc | *actual/expected √ó 100* |
| **batch_id** | FK ‚Üí batches opt | *cross-domain* |
| **executed_at** | TIMESTAMPTZ | |

---

### Dominio: Actividades

#### activity_types

Tipos base de actividad (~15-30 registros). Clasificaci√≥n de primer nivel para agrupaci√≥n y reporting.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **name** | VARCHAR | *'Fertirrigaci√≥n', 'Poda', 'Cosecha', 'Trasplante'* |
| **category** | VARCHAR opt | |
| **is_active** | BOOLEAN | *default true* |

#### activity_templates

Receta de actividad reutilizable con recursos, checklist y reglas de negocio. Al programar o ejecutar una actividad se toma un snapshot del estado actual del template; cambios futuros no afectan lo ya programado o ejecutado. Fases aplicables via tabla de uni√≥n activity_template_phases.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **code** | VARCHAR UNIQUE | *FERT-VEG-S1, HARV-MANUAL-CUT* |
| **activity_type_id** | FK ‚Üí activity_types | |
| **name** | VARCHAR | *'Fertirrigaci√≥n Vegetativa Sem 1-2'* |
| **frequency** | ENUM | *daily \| weekly \| biweekly \| once \| on_demand* |
| **estimated_duration_min** | INT | *30, 90, 360* |
| **trigger_day_from** | INT opt | *d√≠a m√≠nimo del ciclo* |
| **trigger_day_to** | INT opt | *d√≠a m√°ximo del ciclo* |
| **depends_on_template_id** | FK ‚Üí self opt | *secado depende de cosecha* |
| **triggers_phase_change_id** | FK ‚Üí production_phases opt | *al completar ‚Üí avanza fase* |
| **triggers_transformation** | BOOLEAN | *cosecha genera transformation_out/in* |
| **metadata** | JSONB opt | *{EC_target, pH_target, temp_range, benchmarks}* |
| **is_active** | BOOLEAN | *default true* |

#### activity_template_phases

Tabla de uni√≥n template‚Üîfases con FK enforcement e √≠ndices eficientes. UNIQUE(template_id, phase_id).

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **template_id** | FK ‚Üí activity_templates | |
| **phase_id** | FK ‚Üí production_phases | |

#### activity_template_resources

Recursos planeados por template con 5 modos de escalado autom√°tico seg√∫n el contexto de ejecuci√≥n.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **template_id** | FK ‚Üí activity_templates | |
| **product_id** | FK ‚Üí products | *conecta con cat√°logo inventario (cross-domain)* |
| **quantity** | DECIMAL | *0.8 (g/L), 5 (L/planta), 0.5 (horas)* |
| **quantity_basis** | ENUM | *fixed \| per_plant \| per_m2 \| per_zone \| per_L_solution* |
| **is_optional** | BOOLEAN | |
| **sort_order** | INT | |
| **notes** | TEXT opt | |

#### activity_template_checklist

Pasos del checklist por template ‚Äî verificaciones obligatorias o informativas en campo.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **template_id** | FK ‚Üí activity_templates | |
| **step_order** | INT | |
| **instruction** | TEXT | *'Verificar EC del drenaje'* |
| **is_critical** | BOOLEAN | *true = bloquea completar sin cumplir* |
| **requires_photo** | BOOLEAN | |
| **expected_value** | VARCHAR opt | *'5.8-6.2'* |
| **tolerance** | VARCHAR opt | *'¬±0.2'* |

#### cultivation_schedules

Plan maestro de cultivo ‚Äî genera actividades autom√°ticamente al crear un batch a partir de una orden aprobada.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **name** | VARCHAR | *'Plan Gelato Indoor 127 d√≠as'* |
| **cultivar_id** | FK ‚Üí cultivars | *cross-domain* |
| **total_days** | INT | *127* |
| **phase_config** | JSONB | *[{phase_id, duration_days, templates:[...]}]* |
| **is_active** | BOOLEAN | *default true* |

#### scheduled_activities

Actividad programada del plan. Guarda un template_snapshot JSONB al momento de programar para que cambios futuros al template no afecten lo ya programado.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **schedule_id** | FK ‚Üí cultivation_schedules | |
| **template_id** | FK ‚Üí activity_templates | |
| **batch_id** | FK ‚Üí batches | *cross-domain* |
| **planned_date** | DATE | |
| **crop_day** | INT | *d√≠a 45 del ciclo* |
| **phase_id** | FK ‚Üí production_phases | *cross-domain* |
| **template_snapshot** | JSONB opt | *{resources, checklist, metadata} al programar* |
| **status** | ENUM | *pending \| completed \| skipped \| overdue* |
| **completed_activity_id** | FK ‚Üí activities opt | *se llena al ejecutar* |

#### activities [CORE]

Registro REAL de ejecuci√≥n ‚Äî lo que realmente pas√≥ en campo. Puede originarse de un scheduled_activity o ser ad-hoc. Conecta batch, zona y fase para trazabilidad completa. El campo measurement_data captura mediciones estructuradas tomadas durante la ejecuci√≥n (pH, EC, vol√∫menes, etc.) cuyo schema esperado se define en el template.metadata.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **activity_type_id** | FK ‚Üí activity_types | |
| **template_id** | FK ‚Üí activity_templates opt | *puede ser ad-hoc sin template* |
| **scheduled_activity_id** | FK ‚Üí scheduled_activities opt | |
| **batch_id** | FK ‚Üí batches | *cross-domain* |
| **zone_id** | FK ‚Üí zones | *cross-domain* |
| **performed_by** | FK ‚Üí users | |
| **performed_at** | TIMESTAMPTZ | |
| **duration_minutes** | INT | |
| **phase_id** | FK ‚Üí production_phases | *cross-domain* |
| **crop_day** | INT opt | |
| **status** | ENUM | *in_progress \| completed \| cancelled* |
| **measurement_data** | JSONB opt | *mediciones capturadas: {water_ph, solution_ec, total_volume_l, equipment, lysimeter_code, ...}* |
| **notes** | TEXT opt | |

#### activity_resources

Recursos REALMENTE consumidos ‚Äî genera inventory_transactions autom√°ticamente al registrarse.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **activity_id** | FK ‚Üí activities | |
| **product_id** | FK ‚Üí products | *cross-domain* |
| **inventory_item_id** | FK ‚Üí inventory_items opt | *de qu√© lote espec√≠fico* |
| **quantity_planned** | DECIMAL opt | *del template escalado* |
| **quantity_actual** | DECIMAL | *lo que realmente se us√≥* |
| **unit_id** | FK ‚Üí units_of_measure | |
| **cost_total** | DECIMAL opt | |
| **transaction_id** | FK ‚Üí inventory_transactions opt | *la transacci√≥n generada* |

#### activity_observations

Observaciones de campo ‚Äî plagas, enfermedades, deficiencias, mediciones. Para monitoreos fitosanitarios (MIPE), captura datos estructurados: agente identificado del cat√°logo, parte de planta, incidencia y severidad num√©ricas. Fotos via tabla attachments (entity_type='observation').

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **activity_id** | FK ‚Üí activities | |
| **type** | ENUM | *pest \| disease \| deficiency \| environmental \| general \| measurement* |
| **agent_id** | FK ‚Üí phytosanitary_agents opt | *agente del cat√°logo ‚Äî null para observaciones no fitosanitarias (cross-domain PROD)* |
| **plant_part** | ENUM opt | *root \| stem \| leaf \| flower \| fruit \| whole_plant* |
| **incidence_value** | DECIMAL opt | *15 individuos (plagas) o 23.5% (enfermedades)* |
| **incidence_unit** | ENUM opt | *count \| percentage* |
| **severity** | ENUM | *info \| low \| medium \| high \| critical ‚Äî categ√≥rico, para alertas y priorizaci√≥n* |
| **severity_pct** | DECIMAL opt | *% de √°rea afectada del √≥rgano/planta ‚Äî dato agron√≥mico preciso* |
| **sample_size** | INT opt | *plantas evaluadas en este muestreo* |
| **description** | TEXT | *detalles espec√≠ficos del hallazgo, o texto libre si agent_id es null* |
| **affected_plants** | INT opt | *plantas afectadas (complementa incidencia)* |
| **action_taken** | TEXT opt | |

---

### Dominio: Nexo (Batches)

#### batches [CORE]

NEXO CENTRAL del modelo ‚Äî conecta los 9 dominios. Su status es gen√©rico (active | phase_transition | completed | cancelled | on_hold) y la fase actual la da current_phase_id. Soporta genealog√≠a via parent_batch_id para splits de lotes.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **code** | VARCHAR UNIQUE | *LOT-GELATO-260301* |
| **cultivar_id** | FK ‚Üí cultivars | *cross-domain PROD* |
| **zone_id** | FK ‚Üí zones | *zona actual ‚Äî cross-domain √ÅREAS* |
| **plant_count** | INT | *42 plantas* |
| **area_m2** | DECIMAL opt | |
| **source_inventory_item_id** | FK ‚Üí inventory_items opt | *cross-domain INV* |
| **current_product_id** | FK ‚Üí products opt | *cross-domain INV* |
| **schedule_id** | FK ‚Üí cultivation_schedules opt | *cross-domain ACT* |
| **current_phase_id** | FK ‚Üí production_phases | *cross-domain PROD ‚Äî define el estado real* |
| **production_order_id** | FK ‚Üí production_orders opt | *cross-domain √ìRDENES* |
| **parent_batch_id** | FK ‚Üí self opt | *batch origen en caso de split* |
| **start_date** | DATE | |
| **expected_end_date** | DATE opt | |
| **status** | ENUM | *active \| phase_transition \| completed \| cancelled \| on_hold* |
| **yield_wet_kg** | DECIMAL opt | |
| **yield_dry_kg** | DECIMAL opt | |
| **total_cost** | DECIMAL calc | *SUM(inventory_transactions.cost_total WHERE batch_id)* |

#### batch_lineage

Registro de splits y merges entre batches para trazabilidad completa. Cada registro documenta una operaci√≥n con cantidad transferida, raz√≥n y responsable.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **operation** | ENUM | *split \| merge* |
| **parent_batch_id** | FK ‚Üí batches | *batch origen* |
| **child_batch_id** | FK ‚Üí batches | *batch destino* |
| **quantity_transferred** | DECIMAL | *plantas o kg transferidos* |
| **unit_id** | FK ‚Üí units_of_measure | |
| **reason** | TEXT | *'10 plantas retrasadas', 'Consolidar secado'* |
| **performed_by** | FK ‚Üí users | |
| **performed_at** | TIMESTAMPTZ | |

---

### Dominio: √ìrdenes

#### production_orders [CORE]

Orden de producci√≥n ‚Äî selecciona cultivar, cantidad, y subconjunto de fases a ejecutar. Los entry/exit points permiten que un vivero opere fases 1-2, un procesador 5-7, y un cultivador full-cycle 1-7 con el mismo modelo.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **code** | VARCHAR UNIQUE | *'OP-2026-001'* |
| **company_id** | FK ‚Üí companies | |
| **cultivar_id** | FK ‚Üí cultivars | |
| **entry_phase_id** | FK ‚Üí production_phases | *donde empieza* |
| **exit_phase_id** | FK ‚Üí production_phases | *donde termina* |
| **initial_quantity** | DECIMAL | *50 semillas, 100 esquejes, 21kg flor* |
| **initial_unit_id** | FK ‚Üí units_of_measure | |
| **initial_product_id** | FK ‚Üí products opt | *producto de entrada si ya existe* |
| **expected_output_quantity** | DECIMAL opt | *calculado en cascada desde yields* |
| **expected_output_product_id** | FK ‚Üí products opt | |
| **zone_id** | FK ‚Üí zones opt | *zona inicial* |
| **planned_start_date** | DATE | |
| **planned_end_date** | DATE opt | *calculado desde phase durations* |
| **assigned_to** | FK ‚Üí users opt | |
| **status** | ENUM | *draft \| approved \| in_progress \| completed \| cancelled* |
| **priority** | ENUM | *low \| normal \| high \| urgent* |
| **notes** | TEXT opt | |

#### production_order_phases

Fases seleccionadas de la orden con planificaci√≥n individual y registro de ejecuci√≥n real (input/output/yield por fase).

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **order_id** | FK ‚Üí production_orders | |
| **phase_id** | FK ‚Üí production_phases | |
| **sort_order** | INT | |
| **planned_start_date** | DATE opt | |
| **planned_end_date** | DATE opt | |
| **planned_duration_days** | INT opt | *override del default cultivar* |
| **zone_id** | FK ‚Üí zones opt | *zona asignada para esta fase* |
| **actual_start_date** | DATE opt | |
| **actual_end_date** | DATE opt | |
| **batch_id** | FK ‚Üí batches opt | *batch asignado cuando inicia* |
| **input_quantity** | DECIMAL opt | *lo que entr√≥ realmente* |
| **output_quantity** | DECIMAL opt | *lo que sali√≥ realmente* |
| **yield_pct** | DECIMAL opt | *output/input √ó 100* |
| **status** | ENUM | *pending \| ready \| in_progress \| completed \| skipped* |

---

### Dominio: Calidad

#### quality_tests

An√°lisis de laboratorio por batch. Flexible para cualquier cultivo: THC/CBD para cannabis, brix para frutas, calibre para hortalizas, contaminantes y pesticidas para todos.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **batch_id** | FK ‚Üí batches | *cross-domain* |
| **phase_id** | FK ‚Üí production_phases opt | *en qu√© fase se tom√≥ la muestra* |
| **test_type** | VARCHAR | *'potency', 'contaminants', 'brix', 'caliber'* |
| **lab_name** | VARCHAR opt | *'ChemHistory Labs'* |
| **lab_reference** | VARCHAR opt | *n√∫mero de muestra del lab* |
| **sample_date** | DATE | |
| **result_date** | DATE opt | |
| **status** | ENUM | *pending \| in_progress \| completed \| failed \| rejected* |
| **overall_pass** | BOOLEAN opt | *true si todos los par√°metros pasaron* |
| **notes** | TEXT opt | |
| **performed_by** | FK ‚Üí users opt | |

#### quality_test_results

Resultado individual por par√°metro. Soporta valores textuales y num√©ricos con thresholds para aprobaci√≥n autom√°tica.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **test_id** | FK ‚Üí quality_tests | |
| **parameter** | VARCHAR | *'THC', 'CBD', 'Brix', 'E.coli', 'Limonene'* |
| **value** | VARCHAR | *'23.5', '< 0.01', 'positive'* |
| **numeric_value** | DECIMAL opt | *23.5 para comparaciones program√°ticas* |
| **unit** | VARCHAR opt | *'%', 'ppm', 'CFU/g', 'mg/g'* |
| **min_threshold** | DECIMAL opt | *l√≠mite inferior aceptable* |
| **max_threshold** | DECIMAL opt | *l√≠mite superior aceptable* |
| **passed** | BOOLEAN opt | *null si no aplica threshold* |

---

### Dominio: Regulatorio

#### regulatory_doc_types

Cat√°logo de tipos de documentos regulatorios disponibles para la empresa. Cada tipo define un schema de campos din√°micos (required_fields) que las instancias deben cumplir. Configurado por admin.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **company_id** | FK ‚Üí companies | |
| **name** | VARCHAR | *'Certificado de An√°lisis (CoA)', 'Ficha T√©cnica SDS', 'Gu√≠a ICA'* |
| **code** | VARCHAR UNIQUE per company | *'COA', 'SDS', 'PHYTO', 'ORGANIC', 'ICA_GUIDE'* |
| **description** | TEXT opt | *Para qu√© sirve y cu√°ndo se requiere* |
| **required_fields** | JSONB | *Schema: {"fields": [{key, label, type, required, options?, placeholder?, help_text?}]}* |
| **valid_for_days** | INT opt | *Vigencia en d√≠as desde issue_date ‚Äî null = no vence* |
| **issuing_authority** | VARCHAR opt | *'ICA', 'INVIMA', 'Lab acreditado', 'Productor'* |
| **category** | ENUM | *'quality' \| 'transport' \| 'compliance' \| 'origin' \| 'safety' \| 'commercial'* |
| **sort_order** | INT | |
| **is_active** | BOOLEAN | *default true* |

Tipos soportados para fields dentro de required_fields: `text`, `textarea`, `date`, `number`, `boolean`, `select` (con `options: []`).

#### product_regulatory_requirements

Define qu√© documentos regulatorios necesita cada producto o categor√≠a de productos. Soporta herencia: requerimientos de categor√≠a se heredan a todos sus productos. Esta es la "secci√≥n de documentaci√≥n regulatoria" visible en el editor de producto.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **product_id** | FK ‚Üí products opt | *Requerimiento a nivel producto espec√≠fico* |
| **category_id** | FK ‚Üí resource_categories opt | *O a nivel categor√≠a ‚Äî hereda a todos sus productos* |
| **doc_type_id** | FK ‚Üí regulatory_doc_types | |
| **is_mandatory** | BOOLEAN | *default true ‚Äî false = recomendado pero no bloqueante* |
| **applies_to_scope** | ENUM | *'per_batch' \| 'per_lot' \| 'per_product' \| 'per_facility'* |
| **frequency** | ENUM | *'once' \| 'per_production' \| 'annual' \| 'per_shipment'* |
| **notes** | TEXT opt | *'Requerido para exportaci√≥n a EU', 'Solo para cannabis medicinal'* |
| **sort_order** | INT | |

CHECK: exactamente uno de `product_id`, `category_id` debe ser NOT NULL.

#### regulatory_documents

Instancias reales de documentos regulatorios capturados. Cada registro tiene field_data que cumple el schema definido en regulatory_doc_types.required_fields, y opcionalmente un archivo adjunto en Supabase Storage.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **company_id** | FK ‚Üí companies | |
| **doc_type_id** | FK ‚Üí regulatory_doc_types | |
| **product_id** | FK ‚Üí products opt | *cross-domain ‚Äî para scope per_product* |
| **batch_id** | FK ‚Üí batches opt | *cross-domain ‚Äî para scope per_batch* |
| **inventory_item_id** | FK ‚Üí inventory_items opt | *cross-domain ‚Äî para scope per_lot* |
| **facility_id** | FK ‚Üí facilities opt | *cross-domain ‚Äî para scope per_facility* |
| **shipment_id** | FK ‚Üí shipments opt | *vincula doc al env√≠o ‚Äî ej: gu√≠a de transporte* |
| **quality_test_id** | FK ‚Üí quality_tests opt | *vincula CoA con su quality_test* |
| **document_number** | VARCHAR opt | *Nro. oficial del documento* |
| **issue_date** | DATE | *Fecha de emisi√≥n* |
| **expiry_date** | DATE opt | *Auto-calculada desde issue_date + valid_for_days, o manual* |
| **status** | ENUM | *'draft' \| 'valid' \| 'expired' \| 'revoked' \| 'superseded'* |
| **field_data** | JSONB | *Valores de los campos definidos en doc_type.required_fields* |
| **file_path** | TEXT opt | *Ruta en Supabase Storage bucket 'regulatory-documents'* |
| **file_name** | VARCHAR opt | *Nombre original del archivo subido* |
| **file_size_bytes** | INT opt | |
| **file_mime_type** | VARCHAR opt | *'application/pdf', 'image/jpeg'* |
| **superseded_by_id** | FK ‚Üí self opt | *Si este doc fue reemplazado por versi√≥n nueva* |
| **verified_by** | FK ‚Üí users opt | *Qui√©n revis√≥/aprob√≥ el documento* |
| **verified_at** | TIMESTAMPTZ opt | |
| **notes** | TEXT opt | |

#### shipment_doc_requirements

Qu√© documentos se requieren para transportar cierto tipo de producto. An√°logo a product_regulatory_requirements pero aplica al contexto de env√≠o/transporte.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **product_id** | FK ‚Üí products opt | *Requerimiento por producto* |
| **category_id** | FK ‚Üí resource_categories opt | *O por categor√≠a* |
| **doc_type_id** | FK ‚Üí regulatory_doc_types | |
| **is_mandatory** | BOOLEAN | *default true* |
| **applies_when** | ENUM | *'always' \| 'interstate' \| 'international' \| 'regulated_material'* |
| **notes** | TEXT opt | *'Requerido por ICA para movilizaci√≥n de material vegetal'* |
| **sort_order** | INT | |

CHECK: exactamente uno de `product_id`, `category_id` debe ser NOT NULL.

#### shipments

Registro de un viaje f√≠sico de material. Un shipment = una entrega que puede contener m√∫ltiples productos. Captura origen, transporte, condiciones y personal involucrado.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **company_id** | FK ‚Üí companies | |
| **shipment_code** | VARCHAR UNIQUE per company | *Auto-generado: 'SHP-2026-0001'* |
| **type** | ENUM | *'inbound' \| 'outbound'* |
| **status** | ENUM | *'scheduled' \| 'in_transit' \| 'received' \| 'inspecting' \| 'accepted' \| 'partial_accepted' \| 'rejected' \| 'cancelled'* |
| **supplier_id** | FK ‚Üí suppliers opt | *cross-domain INV ‚Äî qui√©n env√≠a (inbound)* |
| **origin_name** | VARCHAR opt | *'Vivero Agroplantulas SAS, Rionegro'* |
| **origin_address** | TEXT opt | |
| **origin_latitude** | DECIMAL opt | |
| **origin_longitude** | DECIMAL opt | |
| **destination_facility_id** | FK ‚Üí facilities | *cross-domain √ÅREAS ‚Äî a d√≥nde llega* |
| **carrier_name** | VARCHAR opt | *'Transportes R√°pido SAS'* |
| **carrier_vehicle** | VARCHAR opt | *'Placa ABC-123', 'Refrigerado tipo furg√≥n'* |
| **carrier_driver** | VARCHAR opt | *Nombre del conductor* |
| **carrier_contact** | VARCHAR opt | *Tel√©fono del conductor/transportista* |
| **dispatch_date** | TIMESTAMPTZ opt | *Cu√°ndo sali√≥ del origen* |
| **estimated_arrival_date** | TIMESTAMPTZ opt | |
| **actual_arrival_date** | TIMESTAMPTZ opt | *Cu√°ndo lleg√≥ realmente* |
| **transport_conditions** | JSONB opt | *{temperature_controlled, temperature_range_c, packaging_type, duration_hours, distance_km, cold_chain_maintained, ...}* |
| **purchase_order_ref** | VARCHAR opt | *Referencia de orden de compra externa* |
| **notes** | TEXT opt | |
| **received_by** | FK ‚Üí users opt | *Qui√©n recibi√≥ en facility* |
| **inspected_by** | FK ‚Üí users opt | *Qui√©n hizo la inspecci√≥n de llegada* |
| **inspected_at** | TIMESTAMPTZ opt | |

#### shipment_items

Cada l√≠nea de un env√≠o: qu√© producto, cu√°nto se esperaba, cu√°nto lleg√≥, resultado de inspecci√≥n, y link al inventory_item creado al confirmar recepci√≥n.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **shipment_id** | FK ‚Üí shipments | |
| **product_id** | FK ‚Üí products | *cross-domain INV* |
| **expected_quantity** | DECIMAL | *Lo que deb√≠a llegar seg√∫n la orden/gu√≠a* |
| **received_quantity** | DECIMAL opt | *Lo que realmente lleg√≥ en buen estado* |
| **rejected_quantity** | DECIMAL opt | *Lo que se rechaz√≥* |
| **unit_id** | FK ‚Üí units_of_measure | *cross-domain INV* |
| **supplier_lot_number** | VARCHAR opt | *Lote del proveedor ‚Äî trazabilidad hacia atr√°s* |
| **supplier_batch_ref** | VARCHAR opt | *Referencia del batch de origen del proveedor* |
| **cost_per_unit** | DECIMAL opt | |
| **destination_zone_id** | FK ‚Üí zones opt | *cross-domain √ÅREAS ‚Äî zona donde se almacenar√°* |
| **expiration_date** | DATE opt | *Auto-calculada si producto tiene shelf_life_days* |
| **inspection_result** | ENUM opt | *'accepted' \| 'accepted_with_observations' \| 'rejected' \| 'quarantine'* |
| **inspection_notes** | TEXT opt | *'3 esquejes con ra√≠z da√±ada, 2 con signos de deshidrataci√≥n'* |
| **inspection_data** | JSONB opt | *Datos cuantitativos de inspecci√≥n seg√∫n tipo de material* |
| **inventory_item_id** | FK ‚Üí inventory_items opt | *Se llena al confirmar recepci√≥n ‚Äî link al lote creado* |
| **transaction_id** | FK ‚Üí inventory_transactions opt | *La transacci√≥n type='receipt' generada* |
| **sort_order** | INT | |

---

### Dominio: Operaciones

#### overhead_costs

Costos indirectos no vinculados a actividades espec√≠ficas (energ√≠a, renta, depreciaci√≥n, seguros). Prorrateables a batches seg√∫n la base de asignaci√≥n para calcular COGS real completo.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **facility_id** | FK ‚Üí facilities | |
| **zone_id** | FK ‚Üí zones opt | *null = aplica a toda la facility* |
| **cost_type** | ENUM | *energy \| rent \| depreciation \| insurance \| maintenance \| labor_fixed \| other* |
| **description** | VARCHAR | *'Electricidad Enero 2026'* |
| **amount** | DECIMAL | |
| **currency** | CHAR(3) | |
| **period_start** | DATE | |
| **period_end** | DATE | |
| **allocation_basis** | ENUM | *per_m2 \| per_plant \| per_batch \| per_zone \| even_split* |
| **notes** | TEXT opt | |

#### sensors

Sensores IoT instalados en zonas para monitoreo ambiental continuo.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **zone_id** | FK ‚Üí zones | |
| **type** | ENUM | *temperature \| humidity \| co2 \| light \| ec \| ph \| soil_moisture \| vpd* |
| **brand_model** | VARCHAR opt | *'Trolmaster Aqua-X Pro'* |
| **serial_number** | VARCHAR opt | |
| **calibration_date** | DATE opt | |
| **is_active** | BOOLEAN | *default true* |

#### environmental_readings

Lecturas de sensores. zone_id denormalizado para queries r√°pidas. Permite comparar condiciones reales vs √≥ptimas del cultivar.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **sensor_id** | FK ‚Üí sensors | |
| **zone_id** | FK ‚Üí zones | *denormalizado para performance* |
| **parameter** | ENUM | *temperature \| humidity \| co2 \| light_ppfd \| ec \| ph \| vpd* |
| **value** | DECIMAL | |
| **unit** | VARCHAR | *'¬∞C', '%RH', 'ppm', '¬µmol/m¬≤/s'* |
| **timestamp** | TIMESTAMPTZ | |

#### alerts

Alertas y notificaciones del sistema. Usa entity polim√≥rfico (entity_type + entity_id) para vincularse a cualquier tabla del modelo.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **company_id** | UUID | |
| **type** | ENUM | *overdue_activity \| low_inventory \| stale_batch \| expiring_item \| env_out_of_range \| order_delayed \| quality_failed \| regulatory_expiring \| regulatory_missing \| pest_detected \| phi_violation* |
| **severity** | ENUM | *info \| warning \| high \| critical* |
| **title** | VARCHAR opt | |
| **entity_type** | VARCHAR | *'batch', 'inventory_item', 'scheduled_activity', 'sensor', 'regulatory_document', 'shipment', 'activity_observation'* |
| **entity_id** | UUID | |
| **batch_id** | FK ‚Üí batches opt | *cross-domain ‚Äî para asociar la alerta al batch afectado* |
| **message** | TEXT | |
| **triggered_at** | TIMESTAMPTZ | |
| **acknowledged_by** | FK ‚Üí users opt | |
| **acknowledged_at** | TIMESTAMPTZ opt | |
| **resolved_at** | TIMESTAMPTZ opt | |
| **status** | ENUM | *pending \| acknowledged \| resolved* |

#### attachments

Adjuntos gen√©ricos (fotos, certificados, documentos regulatorios, PDFs) vinculables a cualquier entidad del sistema.

| Campo | Tipo | Detalle |
|---|---|---|
| **id** | UUID PK | |
| **entity_type** | VARCHAR | *'activity', 'batch', 'quality_test', 'observation'* |
| **entity_id** | UUID | |
| **file_url** | TEXT | |
| **file_type** | VARCHAR | *'image/jpeg', 'application/pdf'* |
| **file_size_bytes** | INT opt | |
| **description** | VARCHAR opt | |
| **uploaded_by** | FK ‚Üí users | |
| **uploaded_at** | TIMESTAMPTZ | |

---

## Relaciones Cross-Domain

Las FKs cross-domain conectan los dominios entre s√≠. Est√°n concentradas en tablas clave: batches (el nexo), inventory_transactions (el log inmutable), activities (la ejecuci√≥n en campo), regulatory_documents (compliance) y shipments (transporte).

### Batch ‚Äî El Nexo Central

| FK | Dominio | Prop√≥sito |
|---|---|---|
| cultivar_id ‚Üí cultivars | **PROD** | Qu√© variedad se cultiva |
| current_phase_id ‚Üí production_phases | **PROD** | En qu√© fase est√° ‚Äî define el estado real del batch |
| production_order_id ‚Üí production_orders | **√ìRDENES** | Qu√© orden lo gener√≥ |
| zone_id ‚Üí zones | **√ÅREAS** | D√≥nde est√° f√≠sicamente |
| current_product_id ‚Üí products | **INV** | Qu√© producto es actualmente en la cadena |
| source_inventory_item_id ‚Üí inventory_items | **INV** | De qu√© semilla/esqueje viene |
| schedule_id ‚Üí cultivation_schedules | **ACT** | Qu√© plan de cultivo sigue |
| parent_batch_id ‚Üí batches | **NEXO** | De qu√© batch se origin√≥ en un split |

### Inventory Transactions ‚Äî El Log Universal

| FK | Dominio | Prop√≥sito |
|---|---|---|
| zone_id ‚Üí zones | **√ÅREAS** | D√≥nde ocurri√≥ el movimiento |
| batch_id ‚Üí batches | **NEXO** | Para qu√© lote |
| phase_id ‚Üí production_phases | **PROD** | En qu√© fase del ciclo |
| activity_id ‚Üí activities | **ACT** | Qu√© actividad lo caus√≥ |
| user_id ‚Üí users | **SYS** | Qui√©n lo ejecut√≥ |

### Regulatory Documents ‚Äî Compliance Multi-entidad

| FK | Dominio | Prop√≥sito |
|---|---|---|
| batch_id ‚Üí batches | **NEXO** | Documento del batch (per_batch) |
| product_id ‚Üí products | **INV** | Documento del producto (per_product) |
| inventory_item_id ‚Üí inventory_items | **INV** | Documento del lote (per_lot) |
| facility_id ‚Üí facilities | **√ÅREAS** | Documento de la facility (per_facility) |
| shipment_id ‚Üí shipments | **REG** | Documento de transporte |
| quality_test_id ‚Üí quality_tests | **QUAL** | CoA vinculado al test de lab |

### Shipments ‚Äî Trazabilidad de Origen

| FK | Dominio | Prop√≥sito |
|---|---|---|
| supplier_id ‚Üí suppliers | **INV** | Qui√©n env√≠a el material |
| destination_facility_id ‚Üí facilities | **√ÅREAS** | A d√≥nde llega |
| shipment_items.product_id ‚Üí products | **INV** | Qu√© productos ven√≠an |
| shipment_items.inventory_item_id ‚Üí inventory_items | **INV** | Lote creado al confirmar |
| inventory_items.shipment_item_id ‚Üí shipment_items | **REG** | Navegaci√≥n inversa: lote ‚Üí env√≠o |

### Jerarqu√≠as Internas por Dominio

| Dominio | Relaci√≥n |
|---|---|
| **SYS** | companies 1‚ÜíN users |
| **PROD** | crop_types 1‚ÜíN cultivars 1‚ÜíN phase_product_flows N‚Üí1 products |
| **PROD** | crop_types 1‚ÜíN production_phases ‚Äî cultivars 1‚ÜíN phase_product_flows N‚Üí1 production_phases |
| **PROD** | production_phases ‚Üíself (depends_on_phase_id) |
| **PROD** | crop_types 1‚ÜíN phytosanitary_agents (opt) ‚Äî companies 1‚ÜíN phytosanitary_agents |
| **√ÅREAS** | facilities 1‚ÜíN zones 1‚ÜíN zone_structures(opt) \| zones 1‚ÜíN plant_positions(opt) |
| **INV** | resource_categories ‚Üíself (parent_id) \| products N‚Üí1 categories + units |
| **INV** | inventory_items N‚Üí1 products \| transactions N‚Üí1 items + ‚Üíself (related) |
| **ACT** | templates 1‚ÜíN template_phases + template_resources + template_checklist |
| **ACT** | cultivation_schedules 1‚ÜíN scheduled_activities N‚Üí1 templates |
| **ACT** | activities 1‚ÜíN activity_resources + activity_observations N‚Üí1 phytosanitary_agents(opt) |
| **NEXO** | batches ‚Üíself (parent_batch_id) \| batches 1‚ÜíN batch_lineage |
| **ORD** | production_orders 1‚ÜíN production_order_phases N‚Üí1 production_phases |
| **QUAL** | quality_tests 1‚ÜíN quality_test_results |
| **REG** | regulatory_doc_types 1‚ÜíN product_regulatory_requirements + shipment_doc_requirements |
| **REG** | regulatory_doc_types 1‚ÜíN regulatory_documents |
| **REG** | shipments 1‚ÜíN shipment_items N‚Üí1 products |
| **REG** | regulatory_documents ‚Üíself (superseded_by_id) |
| **OPS** | sensors 1‚ÜíN environmental_readings \| alerts/attachments ‚Üí entity (polim√≥rfico) |

---

## Flujos Operativos Detallados

Descripci√≥n paso a paso de c√≥mo interact√∫an las tablas durante las operaciones m√°s comunes del sistema. Cada paso indica el dominio que interviene y las tablas afectadas.

### Flujo 1: Crear Orden de Producci√≥n, Batch e Ingreso de Material

*Inicia el ciclo productivo. Un gerente selecciona un cultivar, configura la orden con las fases deseadas, y al aprobar, el sistema genera el batch, programa las actividades, y el operario ejecuta la primera actividad de ingreso de material que formaliza la entrada del recurso al proceso productivo.*

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **PROD** | El gerente selecciona un cultivar (ej: Gelato #41). El sistema carga autom√°ticamente las production_phases del crop_type asociado. Para cannabis: germinaci√≥n, propagaci√≥n, vegetativo, floraci√≥n, cosecha, secado, empaque + madre (8 fases, donde madre es bifurcaci√≥n opcional desde vegetativo). |
| 2 | **ORDER** | Se crea un production_order con: cultivar_id=Gelato, entry_phase_id y exit_phase_id seg√∫n el tipo de operaci√≥n. Ejemplos: full-cycle desde semilla (germinaci√≥n‚Üíempaque), desde esquejes (propagaci√≥n‚Üíempaque), procesador (secado‚Üíempaque), establecimiento de madre (germinaci√≥n‚Üímadre). |
| 3 | **ORDER** | El sistema genera production_order_phases siguiendo la cadena depends_on_phase_id desde entry hasta exit, con planned_duration_days tomados del cultivar.phase_durations o de production_phases.default_duration_days. |
| 4 | **PROD** | C√°lculo en cascada usando phase_product_flows del cultivar Gelato desde entry hasta exit phase. Ejemplo full-cycle: 50 semillas √ó 90% germinaci√≥n √ó 95% propagaci√≥n √ó 98% floraci√≥n √ó 500g/planta √ó 25% ratio seco √ó 80% trimming = ~4.7kg producto final. Cada yield es espec√≠fico del cultivar. Se registra en expected_output_quantity. |
| 5 | **NEXO** | Al aprobar la orden se crea el batch: code='LOT-GELATO-260301', cultivar_id=Gelato, current_phase_id=entry_phase, current_product_id=initial_product, source_inventory_item_id=lote de semillas/esquejes, zone_id=zona asignada, production_order_id=la orden, status='active'. |
| 6 | **ACT** | El cultivation_schedule genera scheduled_activities desde los activity_templates aplicables a cada fase (via activity_template_phases). La PRIMERA actividad es siempre ENTRY-MATERIAL: template de ingreso de material que formaliza la entrada del recurso al batch. Cada scheduled_activity guarda un template_snapshot JSONB. |
| 7 | **INV** | Si hay material en inventario, se genera una reservation (inventory_transaction type='reservation') para reservar la cantidad. quantity_reserved += N en el inventory_item correspondiente. |
| 8 | **ACT** | El operario ejecuta ENTRY-MATERIAL: se crea activity con batch_id, zone_id, phase_id=entry_phase. Los activity_resources registran el material consumido (semillas, esquejes, flor h√∫meda) con quantity_actual y el inventory_item_id espec√≠fico. |
| 9 | **INV** | Se generan dos inventory_transactions: (1) type='release' libera la reserva, (2) type='consumption' registra el consumo real con contexto completo: batch_id, phase_id, activity_id, user_id. El inventory_item pasa a lot_status='depleted' si se consumi√≥ todo. |
| 10 | **ACT** | La actividad ENTRY-MATERIAL pasa a status='completed'. El batch est√° formalmente en producci√≥n con material ingresado, trazable hasta el lote de origen (y si aplica, hasta el shipment, supplier y documentos regulatorios). |

### Flujo 1b: Propagaci√≥n por Semilla (Ciclo Completo)

*Desde la compra de semillas hasta la planta vegetativa lista para floraci√≥n. Demuestra la cadena completa semilla ‚Üí pl√°ntula ‚Üí planta enraizada ‚Üí planta vegetativa con dos transformaciones de fase.*

**phase_product_flows del cultivar Gelato para esta ruta:**

| Fase | direction | product_role | product_id | yield |
|---|---|---|---|---|
| germinaci√≥n | input | primary | SEM-GELATO-FEM | ‚Äî |
| germinaci√≥n | output | primary | SEEDLING-GELATO | 90% (9 de cada 10 germinan) |
| propagaci√≥n | input | primary | SEEDLING-GELATO | ‚Äî |
| propagaci√≥n | output | primary | PLANT-VEG-GELATO | 95% (5% no enra√≠zan bien) |
| vegetativo | input | primary | PLANT-VEG-GELATO | ‚Äî |
| vegetativo | output | primary | PLANT-FLO-GELATO | 98% |

**Flujo paso a paso:**

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **REG** | Semillas llegan via shipment desde proveedor certificado. Inspecci√≥n: viabilidad, integridad de la cubierta, documentos fitosanitarios. Se crea inventory_item: SEM-GELATO-FEM, quantity=50, source_type='purchase'. |
| 2 | **ORDER** | production_order: cultivar=Gelato, entry_phase=germinaci√≥n, exit_phase=empaque, initial_quantity=50, initial_product=SEM-GELATO-FEM. |
| 3 | **NEXO** | Batch creado: LOT-GELATO-260301, current_phase=germinaci√≥n, current_product=SEM-GELATO-FEM, source_inventory_item=lote de semillas. |
| 4 | **ACT** | ENTRY-MATERIAL: operario registra ingreso de 50 semillas al batch. Genera consumption del lote de semillas. Las semillas dejan de ser "stock en almac√©n" y pasan a ser "material en producci√≥n". |
| 5 | **ACT** | Actividades de germinaci√≥n: remojo (24h), siembra en sustrato h√∫medo, control de temperatura (25-28¬∞C), control de humedad (>80%). Duraci√≥n t√≠pica: 3-7 d√≠as. |
| 6 | **INV** | Fin de germinaci√≥n ‚Äî is_transformation=true, is_destructive=true: transformation_out destruye SEM-GELATO-FEM (50 semillas), transformation_in crea SEEDLING-GELATO (45 pl√°ntulas, yield 90%). 5 semillas no viables ‚Üí transaction type='waste'. |
| 7 | **NEXO** | Batch actualiza: current_phase=propagaci√≥n, current_product=SEEDLING-GELATO, plant_count=45. Zone puede cambiar (germinador ‚Üí bandeja de propagaci√≥n). |
| 8 | **ACT** | Actividades de propagaci√≥n: trasplante a alv√©olos individuales, fertirrigaci√≥n suave, luz 18/6, inspecci√≥n de enraizamiento. Duraci√≥n: 10-21 d√≠as. |
| 9 | **INV** | Fin de propagaci√≥n ‚Äî is_transformation=true, is_destructive=false: transformation_out marca SEEDLING-GELATO como transformado, transformation_in crea PLANT-VEG-GELATO (43 plantas, yield 95%). 2 pl√°ntulas d√©biles ‚Üí waste. |
| 10 | **NEXO** | Batch actualiza: current_phase=vegetativo, current_product=PLANT-VEG-GELATO, plant_count=43, zone=Sala Vegetativo. Desde aqu√≠ contin√∫a el ciclo normal (vegetativo ‚Üí floraci√≥n ‚Üí cosecha ‚Üí secado ‚Üí empaque). |

### Flujo 1c: Propagaci√≥n por Esquejes Externos

*La empresa compra esquejes (clones) de un vivero externo y arranca directamente en propagaci√≥n, saltando germinaci√≥n. Demuestra el entry_point flexible y la trazabilidad de transporte.*

**phase_product_flows del cultivar Gelato para esta ruta:**

| Fase | direction | product_role | product_id | yield |
|---|---|---|---|---|
| propagaci√≥n | input | primary | CLONE-GELATO | ‚Äî |
| propagaci√≥n | output | primary | PLANT-VEG-GELATO | 92% (esquejes menos robustos que pl√°ntulas de semilla) |

**Flujo paso a paso:**

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **REG** | Shipment desde vivero: 100 esquejes CLONE-GELATO, transporte refrigerado (8-12¬∞C), documentos: Gu√≠a ICA + certificado fitosanitario + certificado de origen gen√©tico. |
| 2 | **REG** | Inspecci√≥n de llegada: received=98, rejected=2 (ra√≠z da√±ada). inspection_result='accepted_with_observations'. Se crea inventory_item: CLONE-GELATO, quantity=98, shipment_item_id=‚Üë. |
| 3 | **ORDER** | production_order: cultivar=Gelato, **entry_phase=propagaci√≥n** (salta germinaci√≥n), exit_phase=empaque, initial_quantity=98, initial_product=CLONE-GELATO. La germinaci√≥n NO se incluye en production_order_phases. |
| 4 | **NEXO** | Batch creado: LOT-GELATO-260315, current_phase=propagaci√≥n, current_product=CLONE-GELATO, source_inventory_item=lote de esquejes (trazable al shipment y supplier). |
| 5 | **ACT** | ENTRY-MATERIAL: operario registra ingreso de 98 esquejes. consumption del lote de esquejes. Observaci√≥n: "2 esquejes adicionales con signos de deshidrataci√≥n, se mantienen en observaci√≥n". |
| 6 | **ACT** | Actividades de propagaci√≥n: aplicaci√≥n de hormona de enraizamiento, sustrato h√∫medo, c√∫pula de humedad, luz difusa 18/6. Duraci√≥n: 10-14 d√≠as. Inspecci√≥n de ra√≠ces d√≠a 7 y d√≠a 12. |
| 7 | **INV** | Fin de propagaci√≥n: transformation 98 esquejes ‚Üí 90 plantas enraizadas (PLANT-VEG-GELATO, yield 92%). 8 esquejes que no enraizaron ‚Üí waste. |
| 8 | **NEXO** | Batch actualiza: current_phase=vegetativo, current_product=PLANT-VEG-GELATO, plant_count=90. Trazabilidad completa: PLANT-VEG-GELATO ‚Üí batch ‚Üí source_inventory_item ‚Üí shipment_item ‚Üí shipment ‚Üí supplier + docs. |

### Flujo 1d: Planta Madre y Producci√≥n de Clones

*Establecimiento de una planta madre y su ciclo continuo de producci√≥n de clones. La fase 'madre' es una bifurcaci√≥n desde vegetativo: el batch permanece indefinidamente, produciendo clones peri√≥dicamente que alimentan nuevas √≥rdenes de producci√≥n. Demuestra is_transformation=true con is_destructive=false.*

**phase_product_flows del cultivar Gelato para la ruta madre:**

| Fase | direction | product_role | product_id | yield | Notas |
|---|---|---|---|---|---|
| germinaci√≥n | input | primary | SEM-GELATO-FEM | ‚Äî | |
| germinaci√≥n | output | primary | SEEDLING-GELATO | 90% | |
| propagaci√≥n | input | primary | SEEDLING-GELATO | ‚Äî | |
| propagaci√≥n | output | primary | PLANT-VEG-GELATO | 95% | |
| madre | input | primary | PLANT-VEG-GELATO | ‚Äî | *la madre se "consume" solo nominalmente ‚Äî el batch no se destruye* |
| madre | output | primary | CLONE-GELATO | ‚Äî | *expected_quantity_per_input=50 clones por sesi√≥n de corte* |

**Parte 1 ‚Äî Establecimiento de la planta madre:**

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **ORDER** | production_order: cultivar=Gelato, entry_phase=germinaci√≥n, **exit_phase=madre**. initial_quantity=5 semillas (se seleccionar√° la mejor planta como madre). production_order_phases genera: germinaci√≥n ‚Üí propagaci√≥n ‚Üí vegetativo ‚Üí madre (NO incluye floraci√≥n‚Üíempaque). |
| 2 | **NEXO** | Batch creado: LOT-MADRE-GELATO-001, current_phase=germinaci√≥n. El batch sigue el flujo normal de semilla (Flujo 1b pasos 4-9) hasta llegar a vegetativo. |
| 3 | **ACT** | En vegetativo, el supervisor selecciona la mejor planta por vigor, estructura y salud. Si se iniciaron 5 semillas, se hace split (Flujo 4): LOT-MADRE-GELATO-001 queda con 1 planta (la elegida), las otras 4 se separan a un batch de producci√≥n normal. |
| 4 | **NEXO** | Transici√≥n de fase: vegetativo ‚Üí madre. Batch actualiza: current_phase=madre, zone=Sala Madres. La orden pasa a status='completed' pero el **batch permanece status='active'** indefinidamente. |

**Parte 2 ‚Äî Ciclo de producci√≥n de clones (recurrente):**

| # | Dominio | Acci√≥n |
|---|---|---|
| 5 | **ACT** | Actividad programada: template CLONE-CUT, frecuencia=biweekly, asociada a fase madre via activity_template_phases. El template define: triggers_transformation=true, estimated_duration=120min. |
| 6 | **ACT** | El operario ejecuta CLONE-CUT: selecciona ramas apicales, corta 50 esquejes, aplica hormona, registra observaciones sobre vigor de la madre. activity_resources registra insumos consumidos (hormona, gel, alv√©olos, sustrato). |
| 7 | **INV** | Fase madre: is_transformation=true, is_destructive=**false**. El sistema genera transformation_in SIN transformation_out: se crean 50 unidades de CLONE-GELATO como nuevo inventory_item (source_type='production'). La madre NO se destruye ‚Äî el batch mantiene plant_count=1, current_product inalterado. |
| 8 | **INV** | Nuevo inventory_item: product=CLONE-GELATO, quantity=50, source_type='production', zone='Sala Madres'. El lote es trazable al batch madre y a la actividad CLONE-CUT espec√≠fica via transaction.batch_id y transaction.activity_id. |
| 9 | **NEXO** | El batch madre sigue en status='active', current_phase=madre. Recibe actividades de mantenimiento (fertirrigaci√≥n, poda de formaci√≥n, renovaci√≥n de sustrato) intercaladas con los CLONE-CUT peri√≥dicos. |
| 10 | **ORDER** | Los 50 clones producidos alimentan nuevas √≥rdenes de producci√≥n: production_order con entry_phase=propagaci√≥n, initial_product=CLONE-GELATO, source=este inventory_item. El Flujo 1c aplica a partir de ah√≠. |

**Ciclo continuo:** La madre puede producir clones cada 2-3 semanas durante 6-12 meses. Cada sesi√≥n de CLONE-CUT genera un inventory_item independiente con su propia trazabilidad. Cuando la madre se agota o pierde vigor, el batch pasa a status='completed' y se establece una nueva madre.

**Trazabilidad completa de un clon producido internamente:**

```
CLONE-GELATO (inventory_item ‚Äî producido internamente)
‚îÇ
‚îú‚îÄ‚îÄ inventory_transaction type='transformation_in'
‚îÇ   ‚îú‚îÄ‚îÄ batch_id ‚Üí LOT-MADRE-GELATO-001 (la madre que lo produjo)
‚îÇ   ‚îú‚îÄ‚îÄ activity_id ‚Üí CLONE-CUT #47 (sesi√≥n de corte espec√≠fica)
‚îÇ   ‚îî‚îÄ‚îÄ phase_id ‚Üí madre
‚îÇ
‚îú‚îÄ‚îÄ Madre: LOT-MADRE-GELATO-001
‚îÇ   ‚îú‚îÄ‚îÄ cultivar: Gelato #41
‚îÇ   ‚îú‚îÄ‚îÄ Origen: LOT-MADRE-GELATO-001 (batch original de semilla)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ source_inventory_item ‚Üí SEM-GELATO-FEM
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ shipment ‚Üí supplier: "Banco Gen√©tico XYZ"
‚îÇ   ‚îî‚îÄ‚îÄ Historial: 47 sesiones de CLONE-CUT, 2,350 clones producidos
‚îÇ
‚îî‚îÄ‚îÄ Destino: production_order ‚Üí nuevo batch ‚Üí propagaci√≥n ‚Üí ... ‚Üí producto final
```

### Flujo 2: Fertirrigaci√≥n Diaria

*Operaci√≥n rutinaria que demuestra el ciclo completo template ‚Üí scheduled ‚Üí activity ‚Üí transaction. Incluye escalado autom√°tico, checklist de verificaci√≥n y generaci√≥n de alertas.*

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **ACT** | scheduled_activity aparece en el dashboard del operario: template=FERT-VEG-S1, batch=LOT-001, phase=vegetativo, planned_date=hoy, crop_day=35. |
| 2 | **ACT** | El operario inicia la ejecuci√≥n. Se crea un registro en activities: zone_id=Sala Veg A, phase_id=vegetativo, batch_id=LOT-001, performed_by=operario, performed_at=ahora, status='in_progress'. |
| 3 | **ACT** | El sistema escala los recursos del template_snapshot seg√∫n quantity_basis: 42 plantas √ó 5L/planta (per_plant) = 210L agua. Ca(NO‚ÇÉ)‚ÇÇ: 0.8g/L √ó 210L (per_L_solution) = 168g. Se pre-cargan como quantity_planned en activity_resources. |
| 4 | **INV** | El operario confirma cantidades reales. Por cada recurso, activity_resources registra quantity_actual. Se genera inventory_transaction type='application' para cada recurso: Ca(NO‚ÇÉ)‚ÇÇ -168g, agua -210L, etc. |
| 5 | **INV** | El inventory_item de Ca(NO‚ÇÉ)‚ÇÇ: quantity_available -= 168g. La transaction tiene contexto completo: zone_id=Sala Veg A, batch_id=LOT-001, phase_id=vegetativo, activity_id=esta actividad, user_id=operario, cost_total calculado. |
| 6 | **ACT** | El operario completa el checklist: EC=1.8 (target: 1.5-2.0 ‚úì), pH=5.9 (target: 5.8-6.2 ‚úì), drenaje=18% (target: 15-20% ‚úì). Todos los √≠tems is_critical pasan. |
| 7 | **OPS** | Si alg√∫n valor de checklist est√° fuera de rango, se genera autom√°ticamente un registro en alerts: type='env_out_of_range', severity='warning', entity_type='batch', entity_id=LOT-001. |
| 8 | **ACT** | La actividad pasa a status='completed'. scheduled_activity.status='completed' y completed_activity_id apunta a esta actividad. |

### Flujo 3: Cosecha con Multi-Output y Test de Calidad

*La cosecha es la operaci√≥n m√°s compleja: destruye el input (plantas), genera m√∫ltiples outputs (flor h√∫meda, trim, desperdicio), consume insumos, registra fotos, avanza la fase del batch, y dispara un test de calidad.*

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **ACT** | Se ejecuta la actividad HARV-MANUAL-CUT. El template define 18 recursos en 7 categor√≠as, estimated_duration=360min, triggers_transformation=true, triggers_phase_change_id=secado. |
| 2 | **INV** | transformation_out: Se genera inventory_transaction type='transformation_out' para las 42 plantas en floraci√≥n. El inventory_item FLO-GELATO se reduce a 0 y pasa a lot_status='depleted'. |
| 3 | **PROD** | phase_product_flows del cultivar Gelato para la fase 'cosecha' define los outputs: direction='output', product_role='primary' ‚Üí WET-GELATO (flor h√∫meda); product_role='secondary' ‚Üí TRIM-WET-GELATO (trim h√∫medo); product_role='waste' ‚Üí tallos y ra√≠ces. Los productos y yields son espec√≠ficos de Gelato. |
| 4 | **INV** | transformation_in ‚Äî Output primario: Se crea NUEVO inventory_item para WET-GELATO (flor h√∫meda), +21kg. Transaction type='transformation_in', related_transaction_id apunta al transformation_out, target_item_id apunta al nuevo item. |
| 5 | **INV** | transformation_in ‚Äî Output secundario: Se crea NUEVO inventory_item para TRIM-WET-GELATO (trim h√∫medo), +8.4kg. Misma mec√°nica de vinculaci√≥n con related_transaction_id. |
| 6 | **INV** | waste: ~50kg tallos y ra√≠ces. Transaction type='waste', reason='Material no aprovechable, descartado en compostera'. No crea inventory_item de destino. |
| 7 | **INV** | consumption: Los insumos consumidos (6 pares guantes, 300mL alcohol isoprop√≠lico, turkey bags, etc.) generan cada uno su transaction type='consumption' con contexto completo. |
| 8 | **OPS** | Fotos de la cosecha se registran en attachments: entity_type='activity', entity_id=esta actividad, file_type='image/jpeg'. M√∫ltiples fotos, cada una un registro. |
| 9 | **NEXO** | El batch se actualiza: current_phase_id avanza a 'secado', status='phase_transition', current_product_id cambia a WET-GELATO, zone_id cambia a 'Sala Secado'. |
| 10 | **√ÅREAS** | Si existen plant_positions, todas pasan a status='harvested' y current_batch_id se limpia. |
| 11 | **QUAL** | Se crea quality_test: batch_id=LOT-001, phase_id=cosecha, test_type='potency', status='pending'. Cuando el lab devuelva resultados, se crean quality_test_results para THC (23.5%), CBD (0.8%), limonene (12mg/g), etc. |
| 12 | **ORDER** | production_order_phases para 'cosecha': status='completed', input_quantity=42 plantas, output_quantity=21kg flor h√∫meda, yield_pct calculado. |

### Flujo 4: Split de Batch

*Cuando parte de un lote presenta problemas (deficiencia, retraso, contaminaci√≥n), se separa en un batch hijo para tratamiento independiente manteniendo trazabilidad completa.*

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **NEXO** | El supervisor detecta que 8 de las 42 plantas del batch LOT-001 muestran deficiencia severa de calcio. Decide separar las plantas afectadas para tratamiento intensivo sin retrasar el resto del lote. |
| 2 | **NEXO** | Se crea batch_lineage: operation='split', parent_batch_id=LOT-001, child_batch_id=LOT-001-B, quantity_transferred=8 plantas, reason='8 plantas con deficiencia Ca severa', performed_by=supervisor. |
| 3 | **NEXO** | LOT-001 se actualiza: plant_count=34 (de 42). Se crea LOT-001-B: parent_batch_id=LOT-001, plant_count=8, cultivar_id=Gelato (heredado), current_phase_id=vegetativo (misma fase), zone_id puede ser la misma u otra zona. |
| 4 | **ACT** | LOT-001-B recibe scheduled_activities propias con templates correctivos (mayor concentraci√≥n Ca, fertirrigaci√≥n m√°s frecuente). El plan original de LOT-001 contin√∫a sin cambios. |
| 5 | **INV** | Cada batch acumula costos por separado: todas las inventory_transactions llevan batch_id=LOT-001 o batch_id=LOT-001-B seg√∫n corresponda. total_cost de cada batch se calcula independientemente. |
| 6 | **NEXO** | Cuando LOT-001-B se recupera, se puede crear otro batch_lineage operation='merge' para reunificar, o mantener como batches separados hasta el final. La genealog√≠a completa queda registrada. |

### Flujo 5: Procesador de Post-Cosecha (Fases 5-7)

*Una empresa procesadora compra flor h√∫meda y solo ejecuta secado, trimming y empaque. El modelo soporta esto sin adaptaciones, gracias a los entry/exit points de la orden de producci√≥n.*

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **ORDER** | Se crea production_order: cultivar_id=Gelato, entry_phase_id=secado (fase 5), exit_phase_id=empaque (fase 7), initial_quantity=21kg, initial_product_id=WET-GELATO. No se generan phases para germinaci√≥n, vegetativo, floraci√≥n ni cosecha. |
| 2 | **INV** | La flor h√∫meda comprada se registra como inventory_transaction type='receipt': +21kg WET-GELATO, source_type='purchase', cost_per_unit=precio de compra. Se crea el inventory_item correspondiente. |
| 3 | **NEXO** | Se crea el batch: cultivar_id=Gelato, current_phase_id=secado, status='active', source_inventory_item_id=la compra, zone_id=Sala Secado. |
| 4 | **ACT** | Los templates de secado, trimming y empaque se programan y ejecutan con el flujo normal de scheduled_activities ‚Üí activities ‚Üí activity_resources ‚Üí inventory_transactions. |
| 5 | **INV** | Secado: transformation 21kg h√∫meda ‚Üí 5.25kg seca (yield 25%). phase_product_flows del cultivar Gelato para la fase 'secado' define: input=WET-GELATO, output primary=DRY-GELATO con expected_yield_pct=25%. |
| 6 | **QUAL** | Post-secado: quality_test para humedad residual (<12%), presencia de moho (negativo), integridad de tricomas. Los resultados quedan vinculados al batch y fase. |
| 7 | **INV** | Trimming: 5.25kg seca ‚Üí 4.2kg premium (DRY-GELATO-PREMIUM) + 1.05kg trim seco (TRIM-DRY-GELATO). Multi-output via phase_product_flows del cultivar. |
| 8 | **INV** | Empaque: 4.2kg ‚Üí ~150 frascos JAR-GELATO-28G. Cada frasco tiene su inventory_item con batch_number para trazabilidad completa hasta el origen. |
| 9 | **OPS** | overhead_costs: energ√≠a de la sala de secado (15 d√≠as √ó tarifa), renta proporcional del espacio. allocation_basis='per_m2' proratea al batch seg√∫n area_m2 usada. |
| 10 | **ORDER** | Cada production_order_phase registra input/output/yield real. La orden pasa a status='completed'. El batch status='completed'. |

### Flujo 6: Monitoreo Ambiental y Alertas

*Los sensores IoT generan lecturas continuas que se comparan contra condiciones √≥ptimas del cultivar, disparando alertas cuando hay desviaciones.*

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **OPS** | sensors registra un sensor tipo 'temperature' en Sala Floraci√≥n A, brand_model='Trolmaster HCS-1'. Cada 5 minutos el sensor env√≠a datos al sistema. |
| 2 | **OPS** | environmental_readings recibe: sensor_id, zone_id=Sala Floraci√≥n A, parameter='temperature', value=28.5, unit='¬∞C', timestamp=ahora. zone_id denormalizado permite queries r√°pidas sin JOIN a sensors. |
| 3 | **PROD** | El cultivar Gelato #41 tiene optimal_conditions.temp='20-26¬∞C'. La lectura de 28.5¬∞C est√° fuera del rango √≥ptimo. |
| 4 | **OPS** | Se genera alert: type='env_out_of_range', severity='warning', entity_type='sensor', entity_id=el sensor, message='Temperatura 28.5¬∞C excede rango √≥ptimo (20-26¬∞C) en Sala Floraci√≥n A'. |
| 5 | **OPS** | El supervisor recibe la alerta, investiga, ajusta el HVAC. Registra acknowledged_by=supervisor, acknowledged_at=ahora. |
| 6 | **OPS** | Cuando la temperatura vuelve al rango, resolved_at se llena. El historial completo de alertas permite an√°lisis de incidentes por zona, periodo y severidad. |

### Flujo 7: Recepci√≥n con Trazabilidad de Transporte

*Material vegetal regulado (semillas, esquejes) llega con documentaci√≥n de transporte obligatoria. El sistema registra el viaje completo, inspecciona el material, captura documentos, y al confirmar genera los lotes de inventario.*

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **REG** | El supervisor crea un shipment: supplier='Banco Gen√©tico XYZ', origin='Rionegro', carrier='Transportes Fr√≠os SAS', vehicle='Placa ABC-123', type='inbound', status='received'. |
| 2 | **REG** | Se agregan shipment_items: 100 semillas SEM-GELATO-FEM, supplier_lot='BG-2026-089', cost_per_unit=$2.50, destination_zone='Almac√©n Semillas'. |
| 3 | **REG** | El sistema consulta shipment_doc_requirements para los productos del env√≠o. Para la categor√≠a 'material_vegetal': Gu√≠a ICA (mandatory), Certificado de origen gen√©tico (mandatory), Factura (mandatory). |
| 4 | **REG** | El supervisor sube/llena cada documento requerido. INSERT regulatory_documents con field_data seg√∫n el schema del doc_type, file adjunto en Supabase Storage, shipment_id=este env√≠o. |
| 5 | **REG** | Inspecci√≥n: por cada l√≠nea, registrar received_quantity=98, rejected_quantity=2, inspection_result='accepted_with_observations', inspection_data={seed_coat_intact:true, viable:98, damaged:2}. |
| 6 | **INV** | Al confirmar: INSERT inventory_item (lote de 98 semillas) + INSERT inventory_transaction type='receipt'. UPDATE shipment_items.inventory_item_id y transaction_id. UPDATE inventory_items.shipment_item_id. |
| 7 | **INV** | Las 2 semillas rechazadas: INSERT inventory_transaction type='waste' o type='return'. |
| 8 | **REG** | Shipment status ‚Üí 'accepted' (o 'partial_accepted'). Si hay documentos mandatorios faltantes ‚Üí INSERT alert type='regulatory_missing'. |

### Flujo 8: Trazabilidad Completa Hacia Atr√°s

*Un auditor quiere verificar la cadena completa de un frasco de producto final. El sistema permite navegar desde el frasco hasta el origen del material vegetal. Se muestran dos rutas: origen por semilla externa y origen por clon de planta madre.*

**Ruta A ‚Äî Origen por semilla externa:**

```
JAR-GELATO-28G (inventory_item ‚Äî producto final empacado)
‚îÇ
‚îú‚îÄ‚îÄ inventory_transaction type='transformation_in'
‚îÇ   ‚îî‚îÄ‚îÄ batch GELATO-2026-001
‚îÇ       ‚îú‚îÄ‚îÄ Actividades: activities ‚Üí activity_resources ‚Üí inventory_transactions
‚îÇ       ‚îú‚îÄ‚îÄ Calidad: quality_tests ‚Üí quality_test_results
‚îÇ       ‚îú‚îÄ‚îÄ Ambiente: environmental_readings
‚îÇ       ‚îú‚îÄ‚îÄ Costos: overhead_costs + activity costs ‚Üí COGS
‚îÇ       ‚îî‚îÄ‚îÄ Documentos regulatorios del batch:
‚îÇ           ‚îú‚îÄ‚îÄ CoA (Certificado de An√°lisis) ‚úÖ ‚Üí quality_test vinculado
‚îÇ           ‚îú‚îÄ‚îÄ Certificado de calidad post-cosecha ‚úÖ
‚îÇ           ‚îî‚îÄ‚îÄ An√°lisis de pesticidas ‚ö†Ô∏è vence en 15 d√≠as
‚îÇ
‚îú‚îÄ‚îÄ Origen: inventory_item SEM-GELATO-FEM (semilla)
‚îÇ   ‚îú‚îÄ‚îÄ Ingreso: activity ENTRY-MATERIAL ‚Üí consumption ‚Üí batch
‚îÇ   ‚îî‚îÄ‚îÄ shipment_item (expected: 100, received: 98, rejected: 2)
‚îÇ       ‚îÇ   inspection_result: 'accepted_with_observations'
‚îÇ       ‚îî‚îÄ‚îÄ shipment SHP-2026-0015
‚îÇ           ‚îú‚îÄ‚îÄ supplier: "Banco Gen√©tico XYZ"
‚îÇ           ‚îú‚îÄ‚îÄ carrier: "Transportes Fr√≠os SAS", veh√≠culo: "ABC-123"
‚îÇ           ‚îú‚îÄ‚îÄ transport_conditions: { temp: 4-8¬∞C, cold_chain: true, 3h }
‚îÇ           ‚îî‚îÄ‚îÄ Documentos de transporte:
‚îÇ               ‚îú‚îÄ‚îÄ Gu√≠a ICA #ANT-2026-00892 ‚úÖ
‚îÇ               ‚îú‚îÄ‚îÄ Certificado de origen gen√©tico ‚úÖ
‚îÇ               ‚îî‚îÄ‚îÄ Factura proveedor #FV-2026-1234 ‚úÖ
‚îÇ
‚îú‚îÄ‚îÄ Documentos del producto (per_product):
‚îÇ   ‚îî‚îÄ‚îÄ Ficha t√©cnica del cultivar Gelato #41 ‚úÖ
‚îÇ
‚îî‚îÄ‚îÄ Documentos de la facility (per_facility):
    ‚îú‚îÄ‚îÄ Licencia de cultivo ICA ‚úÖ (vence dic 2026)
    ‚îú‚îÄ‚îÄ Registro sanitario INVIMA ‚úÖ
    ‚îî‚îÄ‚îÄ Certificado org√°nico ‚ö†Ô∏è (renovaci√≥n en 45 d√≠as)
```

**Ruta B ‚Äî Origen por clon de planta madre:**

```
JAR-GELATO-28G (inventory_item ‚Äî producto final empacado)
‚îÇ
‚îú‚îÄ‚îÄ inventory_transaction type='transformation_in'
‚îÇ   ‚îî‚îÄ‚îÄ batch GELATO-2026-042
‚îÇ       ‚îú‚îÄ‚îÄ (misma estructura de actividades, calidad, costos, docs del batch)
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ Origen: inventory_item CLONE-GELATO (clon producido internamente)
‚îÇ   ‚îú‚îÄ‚îÄ Ingreso: activity ENTRY-MATERIAL ‚Üí consumption ‚Üí batch
‚îÇ   ‚îî‚îÄ‚îÄ inventory_transaction type='transformation_in' (producci√≥n del clon)
‚îÇ       ‚îú‚îÄ‚îÄ activity: CLONE-CUT #47 (sesi√≥n de corte del 15-mar-2026)
‚îÇ       ‚îî‚îÄ‚îÄ batch: LOT-MADRE-GELATO-001 (planta madre)
‚îÇ           ‚îú‚îÄ‚îÄ cultivar: Gelato #41, fase: madre, status: active
‚îÇ           ‚îú‚îÄ‚îÄ Establecida: 01-ene-2026, 47 sesiones, 2,350 clones producidos
‚îÇ           ‚îî‚îÄ‚îÄ Origen de la madre: inventory_item SEM-GELATO-FEM
‚îÇ               ‚îî‚îÄ‚îÄ shipment SHP-2025-0089
‚îÇ                   ‚îú‚îÄ‚îÄ supplier: "Banco Gen√©tico XYZ"
‚îÇ                   ‚îî‚îÄ‚îÄ Documentos: Gu√≠a ICA ‚úÖ, Cert. origen ‚úÖ
‚îÇ
‚îî‚îÄ‚îÄ Documentos de facility: (mismos que Ruta A)
```

### Flujo 9: MIPE ‚Äî Monitoreo Fitosanitario, Aplicaci√≥n y Seguimiento

*Ciclo completo de Manejo Integrado de Plagas y Enfermedades: monitoreo programado ‚Üí detecci√≥n ‚Üí programaci√≥n de aplicaci√≥n ‚Üí ejecuci√≥n con trazabilidad de producto ‚Üí seguimiento de efectividad. Demuestra el uso de phytosanitary_agents, measurement_data, y la integraci√≥n con inventario para productos de protecci√≥n.*

**Parte 1 ‚Äî Monitoreo fitosanitario:**

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **ACT** | scheduled_activity aparece en el dashboard: template=MONITOR-FITOSAN, batch=LOT-GELATO, phase=floraci√≥n, crop_day=45. El template.metadata define: {sampling_method: "zigzag", sample_size_formula: "sqrt(total_plants) √ó 1.5"}. |
| 2 | **ACT** | El agr√≥nomo inicia la ejecuci√≥n. Se crea activity con measurement_data: {sample_size: 15, total_plants: 90, sampling_method: "zigzag", phenological_stage: "floraci√≥n semana 4"}. |
| 3 | **ACT** | Hallazgo 1: activity_observation ‚Äî type='pest', agent_id=‚ÜíACARO_BLANCO, plant_part='leaf', incidence_value=12, incidence_unit='count', severity_pct=15.0, severity='medium', sample_size=15, description='Colonias en env√©s de hojas j√≥venes del tercio superior, mayor concentraci√≥n cerca del sistema de ventilaci√≥n'. |
| 4 | **ACT** | Hallazgo 2: activity_observation ‚Äî type='disease', agent_id=‚ÜíBOTRYTIS_SP, plant_part='flower', incidence_value=8.5, incidence_unit='percentage', severity_pct=5.0, severity='low', sample_size=15, description='Manchas grises incipientes en cogollos densos, zona de baja circulaci√≥n de aire'. |
| 5 | **OPS** | Fotos de cada hallazgo: attachments con entity_type='observation', entity_id=la observaci√≥n, file_type='image/jpeg'. Cada foto preserva metadata EXIF (GPS, timestamp). |
| 6 | **OPS** | El severity='medium' del √°caro blanco genera alert: type='pest_detected', severity='warning', entity_type='activity_observation', entity_id=la observaci√≥n, batch_id=LOT-GELATO, message='√Åcaro blanco detectado en LOT-GELATO, incidencia 12 individuos, severidad 15%'. |

**Parte 2 ‚Äî Programaci√≥n y ejecuci√≥n de aplicaci√≥n:**

| # | Dominio | Acci√≥n |
|---|---|---|
| 7 | **ACT** | El agr√≥nomo programa la aplicaci√≥n: scheduled_activity con template=APLIC-MIPE-FOLIAR, batch=LOT-GELATO, planned_date=ma√±ana. El template define: activity_template_resources con product=Acaricida X (product_id), quantity=2, quantity_basis='per_L_solution'. activity_template_checklist incluye: 'Verificar pH soluci√≥n (5.5-6.5)', 'Verificar EC soluci√≥n', 'Usar EPP completo', 'Cubrir sistema de riego'. |
| 8 | **ACT** | El operario ejecuta. Se crea activity con measurement_data: {water_ph: 6.5, water_ec_ms: 0.3, solution_ph: 5.8, solution_ec_ms: 2.1, total_water_volume_l: 200, total_product_dose_ml: 400, application_type: "foliar", equipment: "Bomba espalda 20L"}. |
| 9 | **ACT** | activity_resources: product=Acaricida X, inventory_item=lote espec√≠fico (con supplier_lot_number para trazabilidad al proveedor), quantity_planned=400mL, quantity_actual=400mL. El sistema trae autom√°ticamente desde products: phi_days=21 (periodo de carencia), rei_hours=4 (periodo de reentrada). Desde inventory_items: batch_number, cost_per_unit. |
| 10 | **INV** | inventory_transaction: type='application', quantity=400mL, batch_id=LOT-GELATO, phase_id=floraci√≥n, activity_id=‚Üë. El inventory_item del acaricida se reduce: quantity_available -= 400mL. |
| 11 | **OPS** | Verificaci√≥n PHI: cosecha estimada en crop_day=75, hoy es crop_day=45, faltan 30 d√≠as. phi_days=21. Margen=9 d√≠as ‚Üí OK. Si phi_days > d√≠as restantes ‚Üí alert type='phi_violation', severity='critical', message='Aplicaci√≥n de Acaricida X viola periodo de carencia. PHI=21 d√≠as, cosecha estimada en 15 d√≠as'. |
| 12 | **OPS** | Verificaci√≥n REI: alert informativa con rei_hours=4. message='Periodo de reentrada: 4 horas. No ingresar a Sala Floraci√≥n A hasta las 14:00'. |

**Parte 3 ‚Äî Seguimiento:**

| # | Dominio | Acci√≥n |
|---|---|---|
| 13 | **ACT** | Se programa monitoreo de seguimiento: template=MONITOR-FITOSAN-SEGUIMIENTO, planned_date=hoy+7, crop_day=52, batch=LOT-GELATO. |
| 14 | **ACT** | El agr√≥nomo ejecuta el seguimiento. Busca √°caro blanco ‚Üí activity_observation: agent_id=‚ÜíACARO_BLANCO, incidence_value=2, severity_pct=3.0, severity='low'. La incidencia baj√≥ de 12‚Üí2 individuos, severidad de 15%‚Üí3%. |
| 15 | **OPS** | Alert original (pest_detected) se marca como resolved_at=ahora. El historial completo queda: detecci√≥n ‚Üí aplicaci√≥n (con producto, lote, dosis) ‚Üí seguimiento ‚Üí resoluci√≥n. |

### Flujo 10: MIRFE ‚Äî Monitoreo Nutricional y Preparaci√≥n de Soluciones

*Manejo Integrado de la Relaci√≥n Fertilizaci√≥n-Extracci√≥n: monitoreo de lis√≠metro/pasta saturada para evaluar disponibilidad nutricional, y preparaci√≥n de soluciones stock con trazabilidad completa de insumos.*

**Parte 1 ‚Äî Monitoreo de lis√≠metro de succi√≥n:**

| # | Dominio | Acci√≥n |
|---|---|---|
| 1 | **ACT** | scheduled_activity: template=MONITOR-LISIMETRO, batch=LOT-GELATO, phase=floraci√≥n. El template.metadata define: {ec_target: "2.0-3.5 mS/cm", ph_target: "5.5-6.5", extraction_wait_hours: 6}. |
| 2 | **ACT** | Instalaci√≥n: el agr√≥nomo ejecuta la actividad. measurement_data registra la primera parte: {lysimeter_code: "LIS-A3-01", plant_id: "P-A3-L2-012", plant_height_cm: 85, phenological_stage: "floraci√≥n sem 4", install_datetime: "2026-03-15T08:00:00"}. |
| 3 | **ACT** | Retiro (6 horas despu√©s): se completa measurement_data: {removal_datetime: "2026-03-15T14:00:00", extracted_volume_ml: 35, ec_ms: 4.8, ph: 5.2}. La UI compara contra template.metadata targets y resalta desviaciones. |
| 4 | **ACT** | EC=4.8 excede rango (2.0-3.5) ‚Üí activity_observation: type='measurement', severity='warning', description='EC soluci√≥n suelo 4.8 mS/cm excede rango √≥ptimo (2.0-3.5). Posible acumulaci√≥n de sales. Recomendar lavado o reducir concentraci√≥n de fertirrigaci√≥n'. |
| 5 | **OPS** | Se genera alert: type='env_out_of_range', severity='warning', entity_type='batch', entity_id=LOT-GELATO, message='EC suelo 4.8 mS/cm en LOT-GELATO excede rango. Acci√≥n requerida en pr√≥xima fertirrigaci√≥n'. |

**Parte 2 ‚Äî Monitoreo de pasta saturada:**

| # | Dominio | Acci√≥n |
|---|---|---|
| 6 | **ACT** | template=MONITOR-PASTA-SATURADA, batch=LOT-GELATO. measurement_data: {sample_number: 3, water_volume_ml: 200, soil_volume_ml: 100, solution_volume_ml: 150, ec_ms: 3.1, ph: 6.0, sample_datetime: "2026-03-16T09:30:00"}. |
| 7 | **ACT** | Los valores est√°n dentro de rango ‚Üí no se genera observaci√≥n de alerta. Los datos quedan registrados para an√°lisis de tendencia: measurement_data es queryable via JSONB operators para graficar EC a lo largo del ciclo. |

**Parte 3 ‚Äî Preparaci√≥n de soluciones stock:**

| # | Dominio | Acci√≥n |
|---|---|---|
| 8 | **INV** | recipe: name='Soluci√≥n Stock A - Vegetativo', output_product=SOL-STOCK-A, base_quantity=10L, items=[{product: Ca(NO‚ÇÉ)‚ÇÇ, quantity: 800g}, {product: KNO‚ÇÉ, quantity: 500g}, {product: MgSO‚ÇÑ, quantity: 300g}]. Cada product tiene en su registro: composici√≥n, registro ICA, proveedor preferido. |
| 9 | **INV** | recipe_execution: recipe=Stock A, scale_factor=5.0 (preparar 50L), executed_by=operario. output_quantity_expected=50L, output_quantity_actual=49.5L, yield_pct=99%. |
| 10 | **ACT** | Actividad asociada: template=PREP-SOL-STOCK. measurement_data: {part_label: "A", water_ph: 7.1, water_ec_ms: 0.2, solution_ph: 4.2, solution_ec_ms: 85.0, water_volume_l: 50}. |
| 11 | **INV** | Consumo de insumos: inventory_transaction type='consumption' para Ca(NO‚ÇÉ)‚ÇÇ (4000g), KNO‚ÇÉ (2500g), MgSO‚ÇÑ (1500g) ‚Äî cada uno con trazabilidad al lote espec√≠fico (inventory_item_id) y al proveedor. |
| 12 | **INV** | Producci√≥n: inventory_transaction type='transformation_in' ‚Üí nuevo inventory_item SOL-STOCK-A, 49.5L, source_type='production'. Este stock se usa luego como recurso en las actividades de fertirrigaci√≥n (Flujo 2), cerrando el ciclo. |

---

## √çndices Recomendados y Queries Habilitadas

### √çndices Compuestos Cr√≠ticos

| Tabla | √çndice | Caso de uso |
|---|---|---|
| inventory_transactions | (batch_id, type, timestamp) | Costeo por batch desglosado por tipo |
| activities | (batch_id, phase_id, performed_at) | Timeline de operaciones por batch y fase |
| scheduled_activities | (batch_id, status, planned_date) | Dashboard de actividades pendientes |
| plant_positions | (zone_id, status) | Ocupaci√≥n de zonas |
| environmental_readings | (zone_id, parameter, timestamp) | Series temporales por zona y par√°metro |
| quality_tests | (batch_id, status) | Tests pendientes por batch |
| alerts | (entity_type, entity_id, resolved_at) | Alertas activas por entidad |
| regulatory_documents | (company_id, status) | Documentos vigentes/vencidos |
| regulatory_documents | (batch_id) WHERE batch_id IS NOT NULL | Documentos por batch |
| regulatory_documents | (expiry_date) WHERE status='valid' | Documentos por vencer |
| shipments | (company_id, status) | Env√≠os por estado |
| shipments | (actual_arrival_date DESC) | Env√≠os recientes |
| shipment_items | (shipment_id) | L√≠neas del env√≠o |
| activity_observations | (activity_id, type) | Observaciones por actividad y tipo |
| activity_observations | (agent_id) WHERE agent_id IS NOT NULL | Incidencias por agente fitosanitario |
| phytosanitary_agents | (company_id, crop_type_id, is_active) | Cat√°logo filtrado por empresa y cultivo |

### Queries Anal√≠ticas Habilitadas

La integraci√≥n cross-domain permite las siguientes consultas:

**1.** COGS completo por batch: costos directos (SUM transactions WHERE batch_id) + overhead prorrateado

**2.** Rendimiento plan vs real por template: quantity_planned vs quantity_actual en activity_resources

**3.** Ocupaci√≥n de zonas: COUNT(plant_positions WHERE status='planted') / zone.plant_capacity

**4.** Trazabilidad semilla ‚Üí producto final: batch.source_inventory_item ‚Üí inventory_items.shipment_item_id ‚Üí shipment_items ‚Üí shipments (con documentos)

**5.** Yield cascada real vs esperado: production_order_phases.yield_pct vs phase_product_flows.expected_yield_pct (por cultivar)

**6.** Condiciones ambientales reales vs √≥ptimas: environmental_readings vs cultivars.optimal_conditions

**7.** Consumo por proveedor √ó periodo: transactions JOIN inventory_items JOIN products JOIN suppliers

**8.** Avance de √≥rdenes: COUNT(order_phases WHERE status='completed') / COUNT(total)

**9.** Resultados de calidad por batch √ó fase: quality_tests JOIN quality_test_results

**10.** Genealog√≠a completa de un batch: batch_lineage recursive con parent/child

**11.** Labor + consumibles por fase √ó batch: activity_resources agrupado por phase_id y category_id

**12.** Alertas activas agrupadas por severidad: alerts WHERE resolved_at IS NULL

**13.** Compliance regulatorio por batch: product_regulatory_requirements ‚Üí regulatory_documents, calculando % de documentos v√°lidos vs requeridos

**14.** Documentos por vencer en los pr√≥ximos 30 d√≠as: regulatory_documents WHERE status='valid' AND expiry_date BETWEEN today AND today+30

**15.** Trazabilidad de transporte por proveedor: shipments ‚Üí shipment_items con inspection_result, tasa de rechazo por proveedor

**16.** Compliance de transporte por env√≠o: shipment_doc_requirements ‚Üí regulatory_documents WHERE shipment_id, documentos faltantes vs cumplidos

**17.** Incidencia por agente fitosanitario √ó periodo: activity_observations JOIN phytosanitary_agents GROUP BY agent_id, mes ‚Äî tendencias de plagas/enfermedades

**18.** Historial MIPE por batch: actividades de monitoreo ‚Üí observaciones ‚Üí aplicaciones ‚Üí seguimiento, con efectividad (reducci√≥n de incidencia post-tratamiento)

**19.** Consumo de productos fitosanitarios por batch √ó fase: activity_resources JOIN products WHERE category='fitosanitario', con phi_days y rei_hours

**20.** Tendencia nutricional por batch: activities.measurement_data‚Üí>'ec_ms' y ‚Üí>'ph' de monitoreos de lis√≠metro/pasta saturada a lo largo del ciclo